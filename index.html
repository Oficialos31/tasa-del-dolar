<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasa VE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para el √≠cono de l√°piz -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        /* Base styles for the DARK theme (Restored Original Look) */
        .theme-dark {
            --bg-color: #0d1117;    /* Fondo principal: Negro/Gris muy oscuro */
            --text-color: #c9d1d9;  /* Texto principal: Blanco/Gris claro */
            --card-bg: #161b22;     /* Fondo de tarjetas: Gris oscuro */
            --border-color: #30363d; /* Bordes */
            --accent-color: #10B981; /* Green-500: Color principal de "Actualizar Tasa" */
            --secondary-text: #8b949e; /* Texto secundario */
            --gradient-start: #34d399; /* Green-400 */
            --gradient-end: #059669; /* Green-600 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            padding: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .card { 
            background-color: var(--card-bg); 
            border: 1px solid var(--border-color); /* Bordes en tarjetas */
        }

        .text-green-400 { color: var(--accent-color); }
        .text-gray-400 { color: var(--secondary-text); }
        
        /* Botones y efectos */
        .gradient-button {
            background-image: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2); 
            color: white; 
            transition: all 0.3s ease;
        }

        .gradient-button:hover {
            background-image: linear-gradient(to right, var(--gradient-end), var(--gradient-start));
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
            transform: translateY(-1px);
        }

        .currency-select, .converter-input {
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease-in-out;
        }
        
        .currency-select:focus, .converter-input:focus { border-color: var(--accent-color); outline: none; }
        
        .spinner {
            border: 4px solid var(--border-color);
            border-radius: 50%;
            border-top: 4px solid var(--accent-color);
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes flash-rate {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            50% { box-shadow: 0 0 10px 5px rgba(16, 185, 129, 0.4); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .rate-flash {
            animation: flash-rate 0.8s ease-out;
        }
        
        .delete-history-item {
            background-color: #EF4444;
            color: white;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            font-size: 0.8rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }

        .delete-history-item:hover {
            background-color: #DC2626;
            transform: scale(1.1);
        }
        
        /* Estilo para el input de la etiqueta dentro del historial oscuro */
        .history-label-input {
            background-color: #2D3748; /* Un gris m√°s oscuro para destacar el input */
            color: white;
            padding: 0.25rem 0.5rem;
            border: 1px solid #4A5568;
            border-radius: 0.25rem;
            max-width: 100%;
        }

        /* Modal de Configuraci√≥n */
        #settings-menu {
            position: absolute;
            top: 65px;
            right: 1.5rem;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 50;
            min-width: 250px;
            padding: 1rem;
            display: none;
        }
        .config-button {
            background-color: var(--border-color);
            color: var(--text-color);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
        }
        .config-button:hover {
            background-color: #3B4452;
        }

        /* Modal de Confirmaci√≥n de ELIMINACI√ìN */
        #confirm-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: none; 
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        #confirm-modal > div {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        /* Estilos espec√≠ficos del modal de confirmaci√≥n */
        #modal-yes-btn {
            background-color: #EF4444; /* Rojo 500 */
            color: white;
            transition: background-color 0.2s ease;
        }
        #modal-yes-btn:hover {
            background-color: #DC2626; /* Rojo 600 */
        }
        
        /* El bot√≥n "No" usa la clase gradient-button (verde) */

        .gear-icon { transition: transform 0.3s ease-in-out; }
        .gear-icon:hover, .gear-icon.active { transform: rotate(45deg); }
        .fixed-gear { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 100; }
        
        /* Estilos para el anuncio simulado en tema oscuro */
        .ad-container { width: 100%; padding: 0; margin-top: 2rem; background-color: #1a222c; border-radius: 0.5rem; border: 1px solid var(--border-color); text-align: center; color: var(--text-color); overflow: hidden; }
        .simulated-ad { display: flex; align-items: center; justify-content: space-between; width: 100%; min-height: 60px; background-color: #2D3748; padding: 8px; cursor: pointer; transition: background-color 0.2s; }
        .simulated-ad:hover { background-color: #3B4452; }
        .ad-icon { flex-shrink: 0; width: 44px; height: 44px; border-radius: 6px; background-color: #10B981; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; }
        .ad-text-content { flex-grow: 1; text-align: left; padding-left: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ad-action-btn { flex-shrink: 0; background-color: #1D4ED8; color: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; transition: background-color 0.2s; }
        .ad-action-btn:hover { background-color: #2563EB; }

    </style>
</head>
<body class="theme-dark">

    <!-- Bot√≥n de configuraci√≥n fijo en la esquina superior derecha -->
    <div class="fixed-gear">
        <button id="settings-btn" class="text-gray-400 hover:text-green-400 focus:outline-none transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 gear-icon" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c.996 .608 2.296 .32 2.572 -1.065z"></path>
                <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0"></path>
            </svg>
        </button>
        <!-- Men√∫ de configuraci√≥n -->
        <div id="settings-menu" class="card rounded-xl p-4 flex flex-col space-y-4">
            <button id="show-time-btn" class="config-button">
                Ver Hora
            </button>
            <button id="clear-history-btn" class="config-button text-red-400">
                Limpiar Historial
            </button>
            <button id="refresh-page-btn" class="config-button">
                Reiniciar App
            </button>
            <div class="text-center text-sm text-gray-500 pt-2">
                Versi√≥n: <span id="app-version">1.1</span>
            </div>
        </div>
    </div>

    <main class="w-full h-full max-w-lg mx-auto min-h-screen p-6 md:p-8 text-center flex flex-col justify-center animate-fade-in-section">
        <div class="flex items-center justify-center space-x-2 w-full mb-4">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-green-400">
                <path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2ZM12 18.5C12 18.2239 11.7761 18 11.5 18H10.5C10.2239 18 10 17.7761 10 17.5V14.5C10 14.2239 10.2239 14 10.5 14H13.5C13.7761 14 14 13.7761 14 13.5V10.5C14 10.2239 13.7761 10 13.5 10H10.5C10.2239 10 10 9.77614 10 9.5V6.5C10 6.22386 10.2239 6 10.5 6H11.5C11.7761 6 12 5.77614 12 5.5V5.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 5.5V18.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h1 class="text-3xl font-bold text-green-400">Tasa VE</h1>
        </div>
        
        <p class="text-gray-400 mb-6">Tasas Actualizadas del Banco Central de Venezuela</p>
        
        <div id="loading" class="flex items-center justify-center space-x-2 text-gray-500 text-lg mb-4">
            <div class="spinner"></div>
            <span>Cargando tasa...</span>
        </div>
        
        <div id="rate-display" class="hidden">
            <div class="card p-4 rounded-lg mb-4 w-full">
                <p class="text-xl text-gray-400">Valor actual:</p>
                <div class="flex items-center justify-center space-x-2">
                    <p class="text-4xl sm:text-5xl font-bold text-green-400 mt-1 mr-2" id="currency-rate">Cargando...</p>
                    <button id="copy-btn" class="text-gray-400 hover:text-green-400 focus:outline-none transition-colors" title="Copiar Tasa">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-2M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2A2 2 0 0114 5m-5 8h4m-4 4h4" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div id="source-label" class="text-sm text-gray-500 mt-2 mb-4">
                <p id="source-text" class="font-semibold"></p>
            </div>
            
            <div id="usdt-notice" class="card p-3 rounded-xl text-sm text-red-400 border border-red-500 hidden">
                <p>‚ö†Ô∏è **ATENCI√ìN:** Tasa USDT basada en promedio P2P. Valor altamente referencial, no oficial. ¬°Opera con cautela!</p>
            </div>

            <div class="text-sm text-gray-500 mt-4 flex flex-col items-center">
                <p><span id="last-updated-label">Fecha Actual:</span> <span id="last-updated" class="font-bold">Cargando...</span></p>
            </div>
        </div>
        <div id="error-message" class="hidden text-red-400 text-sm mt-2"></div>

        <button id="refresh-btn" class="w-full mt-4 text-white font-semibold py-3 px-4 rounded-xl gradient-button pulse-animation">
            Actualizar Tasa
        </button>
        
        <!-- Selectores -->
        <div class="flex justify-center mt-4 space-x-2">
            <select id="currency-display-select" class="currency-select w-1/2">
                <option value="USD">üá∫üá∏ D√≥lar (USD)</option>
                <option value="EUR">üá™üá∫ Euro (EUR)</option>
                <option value="USDT">‚ÇÆ USDT (Tether)</option>
            </select>
             <button id="conversion-toggle-btn" class="w-1/2 text-white card flex items-center justify-center space-x-2 p-3 rounded-lg focus:outline-none transition-colors border border-gray-700 hover:border-green-400">
                <span id="toggle-text">Divisa a Bol√≠vares</span>
                <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>

        <!-- Contenedor de Anuncios: Simulado -->
        <div class="ad-container">
            <div id="simulated-ad-content" class="simulated-ad"></div>
            <div class="text-xs text-gray-500 bg-gray-900 py-1 w-full text-center">
                Anuncio Patrocinado (Simulado)
            </div>
        </div>


        <div class="mt-8 pt-6 border-t border-gray-700 text-left">
            <h2 class="text-2xl font-bold text-green-400 mb-4">Conversor de Divisas</h2>
            
            <div class="flex flex-col space-y-4 mb-4 items-center justify-center">
                <!-- Placeholder actualizado (Cantidad en [Moneda]) -->
                <input type="text" id="amount-input" class="converter-input w-full p-3" placeholder="Cantidad">
                <select id="currency-select" class="converter-input w-full p-3">
                    <option value="USD">üá∫üá∏ D√≥lares (USD)</option>
                    <option value="EUR">üá™üá∫ Euros (EUR)</option>
                    <option value="USDT">‚ÇÆ USDT (Tether)</option>
                </select>
            </div>
            
            <button id="convert-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                Convertir
            </button>
            
            <div id="conversion-result" class="mt-4 p-4 card rounded-lg hidden">
                <div id="converted-value" class="text-3xl font-bold text-green-400 mb-2"></div>
            </div>
        </div>

        <div class="mt-8 pt-6 border-t border-gray-700 text-left">
            <h2 class="text-2xl font-bold text-green-400 mb-4">Historial de Conversiones</h2>
            <ul id="history-list" class="space-y-2 text-gray-400"></ul>
        </div>
        
    </main>

    <!-- Caja de Mensajes (Alertas/Copy) -->
    <div id="message-box" class="hidden">
        <p id="msg-text">¬°Tasa copiada al portapapeles!</p>
    </div>
    
    <!-- Modal de Confirmaci√≥n de ELIMINACI√ìN (NUEVO) -->
    <div id="confirm-modal" class="hidden">
        <div class="rounded-xl p-6 w-11/12 max-w-sm">
            <h3 class="text-xl font-bold mb-4">¬øEst√°s seguro de que quieres eliminar?</h3>
            <p class="text-sm mb-6 text-gray-400">Esta acci√≥n no se puede deshacer.</p>
            <div class="flex justify-end space-x-4">
                <!-- Bot√≥n NO (Verde Degradado) - Lado IZQUIERDO -->
                <button id="modal-no-btn" class="gradient-button py-2 px-4 rounded-lg font-semibold shadow-md transition-shadow hover:shadow-lg">
                    No
                </button>
                <!-- Bot√≥n S√ç (Rojo) - Lado DERECHO -->
                <button id="modal-yes-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors shadow-md hover:shadow-lg">
                    S√≠
                </button>
            </div>
        </div>
    </div>

    
    <script type="module">
        let rates = {};
        let currentCurrency = 'USD';
        let conversionDirection = 'currency-to-bs';
        const HISTORY_KEY = 'conversionHistory';
        let msgTimeout;
        let refreshInterval;
        let currentDeleteIndex = null; // Variable para almacenar el √≠ndice a eliminar

        // Referencias del DOM para el modal de confirmaci√≥n
        const confirmModal = document.getElementById('confirm-modal');
        const modalYesBtn = document.getElementById('modal-yes-btn');
        const modalNoBtn = document.getElementById('modal-no-btn');
        
        const settingsBtn = document.getElementById('settings-btn');
        const settingsMenu = document.getElementById('settings-menu');
        const gearIcon = document.querySelector('.gear-icon');
        const currencyRateElement = document.getElementById('currency-rate');


        // --- LISTENERS GENERALES ---
        settingsBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            const isMenuOpen = settingsMenu.style.display === 'block';
            if (isMenuOpen) {
                settingsMenu.style.display = 'none';
                gearIcon.classList.remove('active');
            } else {
                settingsMenu.style.display = 'block';
                gearIcon.classList.add('active');
            }
        });

        document.getElementById('refresh-page-btn').addEventListener('click', () => {
            window.location.reload();
        });

        document.getElementById('conversion-toggle-btn').addEventListener('click', () => {
            const toggleIcon = document.getElementById('toggle-icon');
            if (conversionDirection === 'currency-to-bs') {
                document.getElementById('toggle-text').textContent = 'Bol√≠vares a Divisa';
                toggleIcon.style.transform = 'rotate(180deg)';
                conversionDirection = 'bs-to-currency';
            } else {
                document.getElementById('toggle-text').textContent = 'Divisa a Bol√≠vares';
                toggleIcon.style.transform = 'rotate(0deg)';
                conversionDirection = 'currency-to-bs';
            }
            updateConversionInputPlaceholder();
        });

        document.getElementById('show-time-btn').addEventListener('click', showCurrentTime);
        document.getElementById('copy-btn').addEventListener('click', copyToClipboard);
        document.getElementById('clear-history-btn').addEventListener('click', clearHistory);
        document.getElementById('currency-display-select').addEventListener('change', (event) => {
            updateDisplay(event.target.value, true); 
        });
        document.getElementById('currency-select').addEventListener('change', () => {
            updateConversionInputPlaceholder();
        });
        document.getElementById('amount-input').addEventListener('input', updateConversionInputPlaceholder);

        document.getElementById('convert-btn').addEventListener('click', convertCurrency);
        document.getElementById('refresh-btn').addEventListener('click', (e) => {
            e.preventDefault();
            initRates(true); // Actualiza solo las tasas con flash
        });

        // Listeners para el modal de confirmaci√≥n
        modalYesBtn.addEventListener('click', () => {
            if (currentDeleteIndex !== null) {
                deleteHistoryItem(currentDeleteIndex, true); // Confirma la eliminaci√≥n
            }
            hideConfirmationModal();
        });

        modalNoBtn.addEventListener('click', hideConfirmationModal);
        
        window.onclick = function(event) {
            const settingsMenu = document.getElementById('settings-menu');
            const settingsBtn = document.getElementById('settings-btn');
            const gearIcon = document.querySelector('.gear-icon');
            if (!settingsBtn.contains(event.target) && !settingsMenu.contains(event.target)) {
                settingsMenu.style.display = 'none';
                gearIcon.classList.remove('active');
            }
            // Si hacen clic fuera del modal de confirmaci√≥n, se cierra
            if (event.target === confirmModal) {
                 hideConfirmationModal();
            }
        }
        

        // --- FUNCIONES DE UTILIDAD (Mensajes, Copy) ---
        function showMessage(message, duration = 3000) {
            const msgBox = document.getElementById('message-box');
            const msgText = document.getElementById('msg-text');
            msgText.textContent = message;
            
            clearTimeout(msgTimeout);
            
            msgBox.style.display = 'block';
            setTimeout(() => { msgBox.style.opacity = 1; }, 10);
            
            msgTimeout = setTimeout(() => { hideMessage(); }, duration);
        }

        function hideMessage() {
            const msgBox = document.getElementById('message-box');
            msgBox.style.opacity = 0;
            setTimeout(() => { msgBox.style.display = 'none'; }, 300);
        }
        
        function copyToClipboard() {
            // Asegura que solo copia el valor num√©rico
            const rateText = currencyRateElement.textContent.trim().split(' ')[1]; 
            
            const tempInput = document.createElement('textarea');
            tempInput.value = rateText; 
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);

            showMessage(`¬°Valor de la Tasa (${rateText}) copiado!`, 3000);
        }

        function applyFlashEffect() {
            currencyRateElement.classList.remove('rate-flash');
            void currencyRateElement.offsetWidth; 
            currencyRateElement.classList.add('rate-flash');
            setTimeout(() => {
                currencyRateElement.classList.remove('rate-flash');
            }, 800);
        }
        
        function showCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-VE', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
            showMessage(`Hora actual: ${timeString}`, 5000);
        }


        // --- L√ìGICA DE TASAS Y UI ---

        function updateUIWithRates(data, isUpdate) {
            rates = data.rates;
            
            const formattedDate = new Intl.DateTimeFormat('es-VE', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            }).format(new Date(data.timestamp));

            document.getElementById('last-updated').textContent = formattedDate;
            document.getElementById('last-updated-label').textContent = 'Fecha Actual:';
            
            updateDisplay(currentCurrency, isUpdate); 
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('rate-display').classList.remove('hidden');
            updateConversionInputPlaceholder();
        }
        
        function updateDisplay(currency, isUpdate = false) {
            const rateInfo = rates[currency];
            const usdtNotice = document.getElementById('usdt-notice');
            const sourceTextElement = document.getElementById('source-text');
            
            currentCurrency = currency;

            if (currency === 'USDT') {
                sourceTextElement.textContent = 'Fuente: Promedio P2P de Cripto-Exchanges';
                usdtNotice.classList.remove('hidden');
            } else {
                sourceTextElement.textContent = 'Fuente: Banco Central de Venezuela (BCV)';
                usdtNotice.classList.add('hidden');
            }

            if (rateInfo) {
                const formattedRate = rateInfo.value.toLocaleString('en-US', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });

                // Asegura el formato correcto del valor, incluyendo el s√≠mbolo Bs
                currencyRateElement.textContent = `${rateInfo.symbol} ${formattedRate}`;
                
                if (isUpdate) {
                    applyFlashEffect();
                }
                
                document.getElementById('currency-select').value = currency;
            }
        }

        function updateConversionInputPlaceholder() {
            const amountInput = document.getElementById('amount-input');
            const currencySelect = document.getElementById('currency-select');
            
            const selectedText = currencySelect.options[currencySelect.selectedIndex].text;
            // Extrae la parte entre par√©ntesis (USD, EUR, etc.)
            const match = selectedText.match(/\((.*?)\)/); 
            const currencyCode = match ? match[1] : '';

            if (conversionDirection === 'bs-to-currency') {
                amountInput.placeholder = 'Cantidad en Bol√≠vares';
            } else {
                amountInput.placeholder = `Cantidad en ${currencyCode}`;
            }
        }

        // --- L√ìGICA DE CONVERSI√ìN Y EXPRESIONES (SOLO + / -) ---

        function calculateExpression(expression) {
            if (typeof expression !== 'string' || expression.trim() === '') return NaN;
            
            let cleanExpression = expression.replace(/\s/g, '').replace(/,/g, '.');

            // 1. Revisar si es solo un n√∫mero
            if (!isNaN(parseFloat(cleanExpression)) && isFinite(cleanExpression) && cleanExpression.indexOf('+') === -1 && cleanExpression.indexOf('-') === -1) {
                return parseFloat(cleanExpression);
            }
            
            // 2. Revisar si solo contiene n√∫meros, puntos decimales y operadores de suma/resta
            if (!/^[\d\.\+\-]+$/.test(cleanExpression)) {
                return NaN; 
            }

            // 3. Intentar evaluaci√≥n simple de SUMA y RESTA
            try {
                // Separa n√∫meros y operadores
                const parts = cleanExpression.match(/(\d+\.?\d*)|[\+\-]/g);
                if (!parts || parts.length === 0) return NaN;

                let result = 0;
                let currentOperator = '+';

                for (let part of parts) {
                    if (part === '+' || part === '-') {
                        currentOperator = part;
                    } else {
                        const number = parseFloat(part);
                        if (isNaN(number)) return NaN;

                        if (currentOperator === '+') {
                            result += number;
                        } else if (currentOperator === '-') {
                            result -= number;
                        }
                    }
                }
                
                return isFinite(result) ? result : NaN;
            } catch (e) {
                return NaN; 
            }
        }

        function convertCurrency() {
            const amountInput = document.getElementById('amount-input');
            const currencySelect = document.getElementById('currency-select');
            const conversionResultDiv = document.getElementById('conversion-result');
            const convertedValueDiv = document.getElementById('converted-value');
            
            const amountExpression = amountInput.value.trim(); 
            const amount = calculateExpression(amountExpression); 

            if (isNaN(amount) || amount <= 0) {
                showMessage("Por favor, agregue un valor v√°lido o expresiones de suma (+) o resta (-)", 5000);
                return;
            }
            
            const currency = currencySelect.value;
            const rateInfo = rates[currency];

            if (!rateInfo) {
                showMessage("La tasa no est√° cargada. Por favor, espere o recargue la p√°gina.", 3000);
                return;
            }
            
            let convertedValue;
            let fromCurrency, toCurrency, fromSymbol, toSymbol;

            if (conversionDirection === 'bs-to-currency') {
                convertedValue = (amount / rateInfo.value);
                fromCurrency = 'Bol√≠vares';
                toCurrency = currency;
                fromSymbol = 'Bs';
                toSymbol = rateInfo.displaySymbol;
            } else {
                convertedValue = (amount * rateInfo.value);
                fromCurrency = currency;
                toCurrency = 'Bol√≠vares';
                fromSymbol = rateInfo.displaySymbol;
                toSymbol = 'Bs';
            }
            
            const formattedConvertedValue = convertedValue.toLocaleString('en-US', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });

            convertedValueDiv.textContent = `${toSymbol} ${formattedConvertedValue}`;
            saveConversionToHistory(amountExpression, amount, fromCurrency, toCurrency, formattedConvertedValue, fromSymbol, toSymbol);
            conversionResultDiv.classList.remove('hidden');
        }
        
        // --- L√ìGICA DEL HISTORIAL (Local Storage) Y EDICI√ìN DE ETIQUETAS ---

        function saveConversionToHistory(expression, amount, fromCurrency, toCurrency, result, fromSymbol, toSymbol) {
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            const timestamp = new Date().toLocaleString('es-VE');
            // A√±adir 'label' por defecto vac√≠o
            history.unshift({ expression, amount, fromCurrency, toCurrency, result, timestamp, fromSymbol, toSymbol, label: '' });
            if (history.length > 10) {
                history.pop();
            }
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            loadHistory();
        }

        function saveLabel(index, newLabel) {
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            if (history[index]) {
                // Asegura un m√°ximo de 30 caracteres
                history[index].label = newLabel.trim().substring(0, 30);
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                loadHistory(); // Recarga para reflejar el cambio
                showMessage("Etiqueta guardada.", 2000);
            }
        }
        
        function toggleLabelEdit(index, isSaving = false) {
            const container = document.getElementById(`history-item-${index}`);
            if (!container) return;

            const displayDiv = container.querySelector('.label-display-div');
            const editDiv = container.querySelector('.label-edit-div');
            const inputField = container.querySelector('.history-label-input');
            const labelDisplay = container.querySelector('.label-display');
            
            if (editDiv.classList.contains('hidden')) {
                // Entrar en modo edici√≥n
                editDiv.classList.remove('hidden');
                displayDiv.classList.add('hidden');
                inputField.focus();
                // inputField.select(); // Deshabilitado para no seleccionar en m√≥vil
            } else {
                // Salir de modo edici√≥n
                editDiv.classList.add('hidden');
                displayDiv.classList.remove('hidden');

                if (!isSaving) {
                    // Si se cancela, restaurar el valor visual actual (si hay)
                    const history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
                    labelDisplay.textContent = history[index]?.label || 'A√±adir etiqueta';
                }
            }
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            if (history.length === 0) {
                historyList.innerHTML = '<p class="text-center text-gray-500">A√∫n no hay conversiones en tu historial.</p>';
                return;
            }

            history.forEach((item, index) => {
                const listItem = document.createElement('li');
                listItem.classList.add('card', 'p-3', 'rounded-lg', 'flex-col', 'sm:flex-row', 'items-start', 'sm:items-center', 'justify-between');
                listItem.id = `history-item-${index}`; // ID para facilitar la edici√≥n

                const displayAmount = item.expression ? item.expression : item.amount.toLocaleString('en-US');

                listItem.innerHTML = `
                    <!-- Columna de Conversi√≥n y Fecha -->
                    <div class="flex-1 w-full sm:w-auto min-w-0">
                        <p class="text-base">
                            <span class="font-bold">${displayAmount} ${item.fromSymbol}</span> a 
                            <span class="text-green-400 font-bold">${item.result} ${item.toSymbol}</span>
                        </p>
                        <p class="text-xs text-gray-500 mb-2 sm:mb-0">${item.timestamp}</p>
                    </div>

                    <!-- Columna de Etiqueta y Bot√≥n de Eliminaci√≥n -->
                    <div class="flex items-center space-x-2 w-full sm:w-auto mt-2 sm:mt-0 ml-0 sm:ml-4 flex-shrink-0">
                        
                        <!-- Modo de Visualizaci√≥n -->
                        <div class="label-display-div flex items-center space-x-2 flex-grow min-w-[120px]">
                            <p class="text-sm italic text-gray-400 label-display truncate max-w-[150px]">${item.label || 'A√±adir etiqueta'}</p>
                            <button class="edit-label-btn text-gray-500 hover:text-green-400 transition-colors flex-shrink-0" data-index="${index}" title="Editar Etiqueta">
                                <i class="fas fa-pencil-alt text-xs"></i>
                            </button>
                        </div>
                        
                        <!-- Modo de Edici√≥n (Oculto) -->
                        <div class="label-edit-div hidden flex items-center space-x-1 flex-grow min-w-[120px]">
                            <input type="text" maxlength="30" value="${item.label || ''}" 
                                class="history-label-input w-full" placeholder="Etiqueta (m√°x 30)">
                            <button class="save-label-btn text-green-400 hover:text-white p-1" data-index="${index}" title="Guardar">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="cancel-label-btn text-red-400 hover:text-white p-1" data-index="${index}" title="Cancelar">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- Bot√≥n de Eliminaci√≥n -->
                        <button class="delete-history-item ml-4" data-index="${index}" title="Eliminar Conversi√≥n">
                            &times;
                        </button>
                    </div>
                `;
                historyList.appendChild(listItem);
            });
            
            // Re-adjuntar listeners para eliminaci√≥n
            document.querySelectorAll('.delete-history-item').forEach(button => {
                button.addEventListener('click', (event) => {
                    // Usar el modal de confirmaci√≥n
                    const index = event.currentTarget.getAttribute('data-index');
                    showConfirmationModal(index);
                });
            });

            // Re-adjuntar listeners para edici√≥n
            document.querySelectorAll('.edit-label-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = e.currentTarget.getAttribute('data-index');
                    toggleLabelEdit(parseInt(index));
                });
            });

            document.querySelectorAll('.save-label-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.getAttribute('data-index'));
                    const inputField = document.querySelector(`#history-item-${index} .history-label-input`);
                    saveLabel(index, inputField.value);
                    toggleLabelEdit(index, true); // Sale del modo edici√≥n
                });
            });
            
            document.querySelectorAll('.cancel-label-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.getAttribute('data-index'));
                    toggleLabelEdit(index, false); // Sale del modo edici√≥n sin guardar
                });
            });
        }

        function deleteHistoryItem(index, confirmed = false) {
            if (!confirmed) return; // Solo procede si est√° confirmado por el modal

            let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            if (index >= 0 && index < history.length) {
                history.splice(index, 1);
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                loadHistory();
                showMessage("Conversi√≥n eliminada.", 3000);
            }
        }
        
        function clearHistory() {
            localStorage.removeItem(HISTORY_KEY);
            loadHistory();
            showMessage("Historial de conversiones limpiado.", 3000);
        }

        // --- L√ìGICA DEL MODAL DE CONFIRMACI√ìN ---
        
        function showConfirmationModal(index) {
            currentDeleteIndex = index;
            confirmModal.style.display = 'flex';
        }

        function hideConfirmationModal() {
            currentDeleteIndex = null;
            confirmModal.style.display = 'none';
        }


        // --- FUNCIONES DE SIMULACI√ìN DE ANUNCIOS ---
        const simulatedAds = [
            { icon: 'üí∞', title: '¬°Gana Criptos Ya! El Juego de Trading que te Paga', action: 'Jugar' },
            { icon: 'üó∫Ô∏è', title: 'Viaja a Los Roques por Menos. ¬°Reserva Ahora!', action: 'Reservar' },
            { icon: 'üìä', title: 'Calculadora de IVA. Simple y R√°pida.', action: 'Instalar' },
            { icon: '‚õΩ', title: 'App para Precios de Gasolina. ¬°Actualizada!', action: 'Descargar' }
        ];

        let currentAdIndex = 0;

        function renderSimulatedAd() {
            const adContainer = document.getElementById('simulated-ad-content');
            const ad = simulatedAds[currentAdIndex];

            adContainer.innerHTML = `
                <div class="ad-icon">${ad.icon}</div>
                <div class="ad-text-content">
                    <p class="text-sm font-semibold">${ad.title}</p>
                    <p class="text-xs text-gray-400">Anuncio - ${ad.action}</p>
                </div>
                <button class="ad-action-btn">${ad.action}</button>
            `;
            
            currentAdIndex = (currentAdIndex + 1) % simulatedAds.length;
        }

        function startAdRotation() {
            setInterval(renderSimulatedAd, 8000); 
        }

        // --- INICIALIZACI√ìN ---

        function initRates(isManualUpdate = false) {
             // Simulando la carga de datos con los valores requeridos
             const data = {
                rates: {
                    'USD': { value: 207.89, symbol: 'Bs', conversion: 207.89, displaySymbol: '$' },
                    'EUR': { value: 242.21, symbol: 'Bs', conversion: 242.21, displaySymbol: '‚Ç¨' },
                    'USDT': { value: 309.40, symbol: 'Bs', conversion: 309.40, displaySymbol: '‚ÇÆ' },
                },
                timestamp: Date.now()
            };
            updateUIWithRates(data, isManualUpdate);
        }
        
        function handleVisibilityChange() {
            if (document.hidden) {
                if (!refreshInterval) {
                    // Si est√° oculta, revisa cada 20s
                    refreshInterval = setInterval(() => {
                        initRates();
                    }, 20000); 
                }
            } else {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
            }
        }
        document.addEventListener("visibilitychange", handleVisibilityChange);

        window.onload = () => {
            initRates(true); 
            loadHistory();
            updateConversionInputPlaceholder();
            renderSimulatedAd(); 
            startAdRotation();   
        };
    </script>
</body>
</html>

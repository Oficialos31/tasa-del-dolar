<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasa VE - Conversor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        /* Base styles for themes */
        .theme-dark {
            --bg-color: #0d1117;
            --text-color: #c9d1d9;
            --card-bg: #161b22;
            --border-color: #30363d;
            --accent-color: #10B981; /* Verde esmeralda (Green-400) */
            --secondary-text: #8b949e;
            --gradient-start: #10B981;
            --gradient-end: #059669;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            padding: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .card { background-color: var(--card-bg); }
        .border-gray-700 { border-color: var(--border-color); }
        .text-green-400 { color: var(--accent-color); }
        .text-gray-400 { color: var(--secondary-text); }
        
        /* General element colors for both themes */
        .gradient-button {
            background-image: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);
            transition: all 0.3s ease;
        }

        .gradient-button:hover {
            background-image: linear-gradient(to right, var(--gradient-end), var(--gradient-start));
            box-shadow: 0 6px 12px rgba(16, 185, 129, 0.4);
            transform: translateY(-2px);
        }

        .converter-input, .currency-select, .modal-textarea {
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease-in-out;
        }
        
        .converter-input:hover, .currency-select:hover { border-color: var(--accent-color); }
        
        .spinner {
            border: 4px solid var(--border-color);
            border-radius: 50%;
            border-top: 4px solid var(--accent-color);
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes flash-rate {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            50% { box-shadow: 0 0 10px 5px rgba(16, 185, 129, 0.4); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .rate-flash {
            animation: flash-rate 0.8s ease-out;
        }

        .delete-history-item, .edit-tag-btn, .view-details-btn {
            color: var(--secondary-text);
            transition: transform 0.2s ease;
            padding: 0.3rem;
            border-radius: 50%;
        }

        .delete-history-item {
            color: #EF4444;
            background-color: transparent;
        }
        
        .edit-tag-btn:hover { color: #3B82F6; } /* Blue */
        .view-details-btn:hover { color: #10B981; } /* Green */
        .delete-history-item:hover { color: #DC2626; transform: scale(1.1); }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #settings-menu {
            position: absolute;
            top: 65px;
            right: 1.5rem;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 50;
            min-width: 250px;
            padding: 1rem;
            display: none;
        }

        .config-button {
            background-color: var(--border-color);
            color: var(--text-color);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
        }
        
        .config-button:hover { background-color: #3B4452; }

        #message-box {
            position: fixed;
            top: 2rem; 
            left: 50%;
            transform: translateX(-50%); 
            padding: 1rem 2rem;
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            text-align: center;
            max-width: 80%;
            white-space: normal;
        }
        
        .gear-icon { transition: transform 0.3s ease-in-out; }
        .gear-icon:hover, .gear-icon.active { transform: rotate(45deg); }
        .fixed-gear { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 100; }

        /* Estilos del modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--card-bg);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            padding: 1.5rem;
            position: relative;
        }
        .modal-textarea {
            background-color: #1f2937;
            border-color: #4b5563;
            color: #d1d5db;
            resize: vertical; /* Permite redimensionamiento vertical para la etiqueta */
            font-family: monospace;
            min-height: 100px; /* Altura m√≠nima para la etiqueta */
        }
    </style>
</head>
<body class="theme-dark">

    <!-- Bot√≥n de configuraci√≥n fijo en la esquina superior derecha -->
    <div class="fixed-gear">
        <button id="settings-btn" class="text-gray-400 hover:text-green-400 focus:outline-none transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 gear-icon" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0m-0 -4v4"></path>
                <path d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c.996 .608 2.296 .32 2.572 -1.065z"></path>
                <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0"></path>
            </svg>
        </button>
        <!-- Men√∫ de configuraci√≥n -->
        <div id="settings-menu" class="card rounded-xl p-4 flex flex-col space-y-4">
            <button id="show-time-btn" class="config-button">
                Ver Hora
            </button>
            <button id="clear-history-btn" class="config-button text-red-400">
                Limpiar Historial
            </button>
            <button id="refresh-page-btn" class="config-button">
                Reiniciar App
            </button>
            <div class="text-center text-sm text-gray-500 pt-2">
                Versi√≥n: <span id="app-version">3.0</span>
            </div>
        </div>
    </div>

    <!-- INICIO DE LA MODIFICACI√ìN DE ADAPTABILIDAD -->
    <!-- Se agregaron clases: md:max-w-xl lg:max-w-2xl para que se vea m√°s grande en pantallas de escritorio -->
    <main class="w-full h-full min-h-screen p-6 md:p-8 text-center flex flex-col justify-center animate-fade-in-section max-w-lg md:max-w-xl lg:max-w-2xl mx-auto">
        <div class="flex items-center justify-center space-x-2 w-full mb-4">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-green-400">
                <path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2ZM12 18.5C12 18.2239 11.7761 18 11.5 18H10.5C10.2239 18 10 17.7761 10 17.5V14.5C10 14.2239 10.2239 14 10.5 14H13.5C13.7761 14 14 13.7761 14 13.5V10.5C14 10.2239 13.7761 10 13.5 10H10.5C10.2239 10 10 9.77614 10 9.5V6.5C10 6.22386 10.2239 6 10.5 6H11.5C11.7761 6 12 5.77614 12 5.5V5.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 5.5V18.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h1 class="text-3xl font-bold text-green-400">Tasa VE</h1>
        </div>
        <!-- FIN DE LA MODIFICACI√ìN DE ADAPTABILIDAD -->
        
        <p class="text-gray-400 mb-6">Tasas Actualizadas del Banco Central de Venezuela</p>
        
        <div class="animated-bar w-full h-1 rounded-full mb-6"></div>

        <!-- Selectores de Divisa -->
        <div class="flex justify-center mb-6">
            <select id="currency-display-select" class="currency-select w-full">
                <option value="USD">üá∫üá∏ D√≥lar (USD)</option>
                <option value="EUR">üá™üá∫ Euro (EUR)</option>
                <option value="USDT">‚ÇÆ USDT (Tether)</option>
            </select>
        </div>

        <div id="loading" class="flex items-center justify-center space-x-2 text-gray-500 text-lg mb-4">
            <div class="spinner"></div>
            <span>Cargando tasa...</span>
        </div>
        
        <div id="rate-display" class="hidden">
            <div class="card p-4 rounded-lg mb-4 w-full">
                <p class="text-xl text-gray-400">Valor actual:</p>
                <div class="flex items-center justify-center space-x-2">
                    <!-- Tasa mostrada con el formato modificado: punto decimal -->
                    <p class="text-4xl sm:text-5xl font-bold text-green-400 mt-1 mr-2" id="currency-rate">Cargando...</p>
                    <button id="copy-btn" class="text-gray-400 hover:text-green-400 focus:outline-none transition-colors" title="Copiar Tasa">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-2M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2A2 2 0 0114 5m-5 8h4m-4 4h4" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- FUENTE DE DATOS VISIBLE -->
            <div id="source-label" class="text-sm text-gray-500 mt-2 mb-4">
                <p id="source-text" class="font-semibold"></p>
            </div>
            
            <!-- DISCLAIMER DE USDT: M√°s prominente y bien ubicado -->
            <div id="usdt-notice" class="card p-3 rounded-xl text-sm text-red-400 border border-red-500 hidden">
                <p>‚ö†Ô∏è **ATENCI√ìN:** Tasa USDT basada en promedio P2P. Valor altamente referencial, no oficial. ¬°Opera con cautela!</p>
            </div>

            <div class="text-sm text-gray-500 mt-4 flex flex-col items-center">
                <p><span id="last-updated-label">Fecha Actual:</span> <span id="last-updated" class="font-bold">Cargando...</span></p>
            </div>
        </div>
        <div id="error-message" class="hidden text-red-400 text-sm mt-2"></div>

        <button id="refresh-btn" class="w-full mt-4 text-white font-semibold py-3 px-4 rounded-xl gradient-button pulse-animation">
            Actualizar Tasa
        </button>

        <div class="mt-8 pt-6 border-t border-gray-700 text-left">
            <h2 class="text-2xl font-bold text-green-400 mb-4">Conversor de Divisas</h2>
            
            <div class="flex justify-center mb-4">
                <button id="conversion-toggle-btn" class="w-full text-white card flex items-center justify-center space-x-2 p-3 rounded-lg focus:outline-none transition-colors border border-gray-700 hover:border-green-400">
                    <span id="toggle-text">Divisa a Bol√≠vares</span>
                    <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

            <div class="flex flex-col space-y-4 mb-4 items-center justify-center">
                <!-- type="text" para aceptar + y - -->
                <input type="text" id="amount-input" class="converter-input w-full p-3" placeholder="Cantidad (ej: 100+50-10)">
                <select id="currency-select" class="converter-input w-full p-3">
                    <option value="USD">üá∫üá∏ D√≥lares (USD)</option>
                    <option value="EUR">üá™üá∫ Euros (EUR)</option>
                    <option value="USDT">‚ÇÆ USDT (Tether)</option>
                </select>
            </div>
            
            <button id="convert-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors">
                Convertir
            </button>
            
            <div id="conversion-result" class="mt-4 p-4 card rounded-lg hidden">
                <div id="converted-value" class="text-3xl font-bold text-green-400 mb-2"></div>
            </div>
        </div>

        <div class="mt-8 pt-6 border-t border-gray-700 text-left">
            <h2 class="text-2xl font-bold text-green-400 mb-4">Historial de Conversiones</h2>
            <ul id="history-list" class="space-y-2 text-gray-400"></ul>
        </div>
    </main>

    <!-- Caja de mensaje temporal (Toast) -->
    <div id="message-box" class="hidden">
        <p id="msg-text">¬°Tasa copiada al portapapeles!</p>
    </div>

    <!-- Modal para Editar Etiqueta (Tag) -->
    <div id="edit-tag-modal" class="modal">
        <div class="modal-content w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">A√±adir/Editar Etiqueta</h3>
            <p class="text-sm text-gray-400 mb-3">Est√°s etiquetando: <span id="edit-modal-input-summary" class="font-semibold text-green-400"></span></p>
            
            <!-- CAMBIO: Controles de Etiqueta y Conteo de Caracteres -->
            <textarea 
                id="tag-input" 
                class="modal-textarea w-full p-3 mb-2" 
                placeholder="Etiqueta o Nota (m√°x. 200 caracteres)"
                maxlength="200"
                rows="4"
            ></textarea>
            <p class="text-xs text-right text-gray-500 mb-4">
                <span id="tag-char-count">0</span> / 200
            </p>
            
            <!-- NUEVO CAMPO: Selecci√≥n Opcional de Pago -->
            <div class="mb-6 pt-4 border-t border-gray-700">
                <label for="payment-select" class="block text-sm font-medium text-gray-400 mb-2">
                    Si has comprado y deseas poner la opci√≥n de pago que utilizaste puedes seleccionar (opcional)
                </label>
                <select id="payment-select" class="modal-textarea w-full p-2 text-sm">
                    <option value="">-- No especificado --</option>
                    <option value="PagoMovil">PagoMovil</option>
                    <option value="Transferencia">Transferencia</option>
                    <option value="Efectivo">Efectivo</option>
                </select>
            </div>
            <!-- FIN NUEVO CAMPO -->

            <div class="flex justify-end space-x-3">
                <button onclick="closeModal('edit-tag-modal')" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Cancelar</button>
                <button id="save-tag-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Ver Detalles (View) -->
    <div id="view-details-modal" class="modal">
        <div class="modal-content w-full max-w-xl">
            <h3 class="text-2xl font-bold mb-4 text-green-400">Detalle de Conversi√≥n</h3>
            <button onclick="closeModal('view-details-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0m-0 -4v4"></path><path d="M18 6l-12 12"></path><path d="M6 6l12 12"></path></svg>
            </button>
            
            <!-- CONTENEDOR DE ETIQUETA -->
            <div class="mb-4 p-5 bg-gray-800 rounded-lg border-l-4 border-blue-500 text-center">
                <p class="text-sm font-semibold uppercase text-blue-300">Etiqueta de Conversi√≥n:</p>
                <p id="view-modal-tag" class="text-xl font-semibold text-white break-words whitespace-pre-wrap mt-1"></p>
            </div>

            <label class="block text-sm font-medium text-gray-400 mb-1">Detalle de la Transacci√≥n:</label>
            <!-- Cuadro de texto grande para la info principal -->
            <textarea 
                readOnly 
                id="view-modal-details" 
                rows="7" 
                class="modal-textarea w-full p-4 text-sm"
            ></textarea>
            
            <!-- Tasa USADA y Timestamp (Info secundaria) -->
            <div id="view-modal-timestamp" class="text-right text-xs text-gray-500 mt-2">
                <!-- Se llenar√° con JS -->
            </div>
        </div>
    </div>
    
    <!-- Modal para Confirmaci√≥n de Eliminaci√≥n (NUEVO) -->
    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content w-full max-w-xs">
            <h3 class="text-xl font-bold mb-4 text-red-500">Confirmaci√≥n Necesaria</h3>
            <p class="text-gray-200 mb-6">¬øEst√°s seguro de eliminar esta conversi√≥n del historial? Esta acci√≥n no se puede deshacer.</p>
            <div class="flex justify-between space-x-3">
                <!-- Bot√≥n NO a la izquierda -->
                <button onclick="closeModal('delete-confirm-modal')" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">No, Cancelar</button>
                <!-- Bot√≥n SI a la derecha -->
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">S√≠, Eliminar</button>
            </div>
        </div>
    </div>
    
    <script>
        let rates = {};
        let currentCurrency = 'USD';
        let conversionDirection = 'currency-to-bs';
        const HISTORY_KEY = 'conversionHistory';
        let msgTimeout;
        let refreshInterval;
        let editingHistoryId = null; // ID del elemento que se est√° editando
        let pendingDeleteId = null; // ID del elemento pendiente de eliminaci√≥n

        const settingsBtn = document.getElementById('settings-btn');
        const settingsMenu = document.getElementById('settings-menu');
        const gearIcon = document.querySelector('.gear-icon');
        const currencyRateElement = document.getElementById('currency-rate');
        const tagInput = document.getElementById('tag-input');
        const tagCharCount = document.getElementById('tag-char-count');
        
        // --- Helpers UI ---
        
        function showMessage(message, duration = 3000) {
            const msgBox = document.getElementById('message-box');
            const msgText = document.getElementById('msg-text');
            msgText.textContent = message;
            
            clearTimeout(msgTimeout);
            
            msgBox.style.display = 'block';
            setTimeout(() => { msgBox.style.opacity = 1; }, 10);
            
            msgTimeout = setTimeout(() => {
                const msgBox = document.getElementById('message-box');
                msgBox.style.opacity = 0;
                setTimeout(() => { msgBox.style.display = 'none'; }, 300);
            }, duration);
        }

        function copyToClipboard() {
            // Extrae solo el valor num√©rico (la tasa)
            const rateText = currencyRateElement.textContent.trim().split(' ')[1]; 
            const tempInput = document.createElement('textarea');
            // La tasa mostrada ahora usa punto decimal, as√≠ que la copiamos tal cual.
            // Reemplazamos las comas por nada, en caso de miles (formato en-US: 1,000.00)
            const valueToCopy = rateText.replace(/,/g, ''); 

            tempInput.value = valueToCopy; 
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showMessage(`¬°Valor de la Tasa (${rateText}) copiado!`, 3000);
        }

        function applyFlashEffect() {
            currencyRateElement.classList.remove('rate-flash');
            void currencyRateElement.offsetWidth; 
            currencyRateElement.classList.add('rate-flash');
            setTimeout(() => { currencyRateElement.classList.remove('rate-flash'); }, 800);
        }

        // --- L√≥gica de Modales (Tagging y Viewing) ---
        
        window.closeModal = function(id) {
            document.getElementById(id).style.display = 'none';
        }

        window.openEditModal = function(id) {
            editingHistoryId = id;
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            const item = history.find(i => i.id === id);

            if (!item) return;

            // Recortar input para mostrar resumen en el modal
            const summary = item.input.length > 50 ? item.input.substring(0, 50) + '...' : item.input;
            document.getElementById('edit-modal-input-summary').textContent = `${summary}`;

            // Cargar datos existentes
            tagInput.value = item.tag || '';
            tagCharCount.textContent = tagInput.value.length;
            // NUEVO: Cargar m√©todo de pago existente
            document.getElementById('payment-select').value = item.paymentMethod || ''; 

            document.getElementById('edit-tag-modal').style.display = 'flex';
        }

        window.openViewModal = function(id) {
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            const item = history.find(i => i.id === id);

            if (!item) return;
            
            // 1. Preparar el texto de Tasa USADA (SIMPLIFICADO) - Se mantiene para el timestamp
            let rateUsedText = '';
            if (item.rateUsed) {
                // Formateamos la tasa utilizada con formato ES-VE (punto miles, coma decimal)
                const storedRate = parseFloat(item.rateUsed).toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                // Formato simplificado: Tasa USADA: Bs [Rate]
                rateUsedText = `
                    <p class="text-sm mt-3 text-gray-400">
                        <span class="font-bold text-yellow-300">Tasa USADA:</span> Bs ${storedRate}
                    </p>
                `;
            }

            // 2. Determinar la etiqueta de la tasa (Tasa USD, EUR, USDT) para el detalle
            // Formateamos la tasa utilizada con formato ES-VE (punto miles, coma decimal)
            const rateUsedFormatted = parseFloat(item.rateUsed).toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            let rateTypeLabel = 'Tasa de Cambio';
            if (item.rateCurrencySymbol === '$') rateTypeLabel = 'Tasa USD';
            else if (item.rateCurrencySymbol === '‚Ç¨') rateTypeLabel = 'Tasa EUR';
            else if (item.rateCurrencySymbol === '‚ÇÆ') rateTypeLabel = 'Tasa USDT';
            
            // 3. Preparar detalles de la transacci√≥n (TEXTO CAMBIADO + NUEVAS L√çNEAS)
            let detailsText = 
                `Monto de Conversi√≥n: ${item.input} ${item.fromSymbol}\n` + 
                `Total de Conversi√≥n: ${item.result} ${item.toSymbol}`;

            // 4. NUEVO: A√±adir M√©todo de Pago
            if (item.paymentMethod && item.paymentMethod !== '') {
                detailsText += `\nM√©todo de Pago: ${item.paymentMethod}`;
            }

            // 5. NUEVO: A√±adir el Valor Actual de la Tasa como √∫ltima l√≠nea
            detailsText += `\n\nValor Actual de la Tasa: ${rateTypeLabel} = Bs ${rateUsedFormatted}`;

            // 6. Actualizar el modal
            document.getElementById('view-modal-tag').textContent = item.tag || 'Sin Etiqueta';
            document.getElementById('view-modal-details').value = detailsText;
            document.getElementById('view-modal-timestamp').innerHTML = `
                <p class="text-xs">ID de Transacci√≥n: ${item.id.substring(0, 8)}...</p>
                <p class="mt-1 text-xs">Fecha: ${item.timestamp}</p>
                ${rateUsedText}
            `;
            document.getElementById('view-details-modal').style.display = 'flex';
        }

        function saveTag() {
            if (!editingHistoryId) return;

            const newTag = tagInput.value.trim().substring(0, 200);
            const newPaymentMethod = document.getElementById('payment-select').value; // OBTENER M√âTODO DE PAGO
            
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            
            history = history.map(item => {
                if (item.id === editingHistoryId) {
                    return { 
                        ...item, 
                        tag: newTag,
                        paymentMethod: newPaymentMethod // GUARDAR M√âTODO DE PAGO
                    };
                }
                return item;
            });

            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            editingHistoryId = null;
            closeModal('edit-tag-modal');
            loadHistory();
            showMessage(`Etiqueta guardada como: ${newTag || 'vac√≠a'}`, 3000);
        }
        
        // --- L√≥gica de Eliminaci√≥n con Confirmaci√≥n ---
        
        function deleteHistoryItem(id) {
            pendingDeleteId = id;
            document.getElementById('delete-confirm-modal').style.display = 'flex';
        }

        function confirmDelete() {
            if (!pendingDeleteId) return;

            let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            history = history.filter(item => item.id !== pendingDeleteId);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            
            pendingDeleteId = null;
            closeModal('delete-confirm-modal');
            loadHistory();
            showMessage("Conversi√≥n eliminada del historial.", 3000);
        }

        // Funci√≥n para limpiar todo el historial
        function clearHistory() {
            localStorage.removeItem(HISTORY_KEY);
            loadHistory();
            showMessage("¬°Historial de conversiones limpiado!", 3000);
            // Cierra el men√∫ de configuraci√≥n si est√° abierto
            settingsMenu.style.display = 'none';
            gearIcon.classList.remove('active');
        }

        // --- L√≥gica de Conversi√≥n y Historial ---

        function evaluateExpression(expression) {
            // Permite d√≠gitos, '.', '+', '-', espacios y comas (que se ignoran)
            const safeExpression = expression.replace(/,/g, '').replace(/[^0-9.+-]/g, '').replace(/\s/g, '');

            if (!safeExpression) return null;

            if (!/[+-]/.test(safeExpression)) {
                const num = parseFloat(safeExpression);
                return isNaN(num) ? null : num;
            }

            try {
                // Funci√≥n eval() segura para aritm√©tica simple.
                const result = new Function('return ' + safeExpression)();
                if (isNaN(result) || !isFinite(result)) {
                    return null;
                }
                return result;
            } catch (e) {
                return null;
            }
        }

        function convertCurrency() {
            const amountInput = document.getElementById('amount-input');
            const currencySelect = document.getElementById('currency-select');
            const conversionResultDiv = document.getElementById('conversion-result');
            const convertedValueDiv = document.getElementById('converted-value');
            
            const rawInput = amountInput.value.trim();
            const evaluatedAmount = evaluateExpression(rawInput);
            
            if (evaluatedAmount === null || evaluatedAmount <= 0) {
                showMessage("Por favor, ingrese una cantidad o expresi√≥n v√°lida (ej: 100+50-10).", 3000);
                conversionResultDiv.classList.add('hidden');
                return;
            }
            
            if (rawInput !== evaluatedAmount.toString() && rawInput !== evaluatedAmount.toFixed(2) && /[+-]/.test(rawInput)) {
                 showMessage(`Expresi√≥n: ${rawInput} = ${evaluatedAmount.toFixed(2)}`, 1500);
            }

            const amount = evaluatedAmount; 
            const currency = currencySelect.value;
            const rateInfo = rates[currency];

            if (!rateInfo) {
                showMessage("La tasa no est√° cargada. Por favor, espere a que se actualice o recargue la p√°gina.", 3000);
                conversionResultDiv.classList.add('hidden');
                return;
            }
            
            let convertedValue;
            let fromCurrency, toCurrency, fromSymbol, toSymbol;

            if (conversionDirection === 'bs-to-currency') {
                convertedValue = (amount / rateInfo.value);
                fromCurrency = 'Bol√≠vares';
                toCurrency = currency;
                fromSymbol = 'Bs';
                toSymbol = rateInfo.displaySymbol;
            } else {
                convertedValue = (amount * rateInfo.value);
                fromCurrency = currency;
                toCurrency = 'Bol√≠vares';
                fromSymbol = rateInfo.displaySymbol;
                toSymbol = 'Bs';
            }
            
            // *** Mantenemos el formato ES-VE (PUNTO MILES, COMA DECIMAL) para el resultado de la transacci√≥n en Bs ***
            const formattedConvertedValue = convertedValue.toLocaleString('es-VE', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
            
            convertedValueDiv.textContent = `${toSymbol} ${formattedConvertedValue}`;

            // Guardamos la expresi√≥n original (rawInput) y la tasa usada
            saveConversionToHistory(rawInput, fromCurrency, toCurrency, formattedConvertedValue, fromSymbol, toSymbol, convertedValue.toFixed(2), rateInfo.value, rateInfo.displaySymbol);
            conversionResultDiv.classList.remove('hidden');
        }
        
        function saveConversionToHistory(rawInput, fromCurrency, toCurrency, result, fromSymbol, toSymbol, numericResult, rateUsed, rateCurrencySymbol) {
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            const timestamp = new Date().toLocaleString('es-VE');

            // Aseguramos que fromCurrency y toCurrency reflejen el texto completo del select para la l√≥gica del modal
            const fromSelect = document.getElementById('currency-select');
            const fromCurrencyName = fromCurrency === 'Bol√≠vares' ? fromCurrency : fromSelect.options[fromSelect.selectedIndex].text.trim();
            const toCurrencyName = toCurrency === 'Bol√≠vares' ? toCurrency : fromSelect.options[fromSelect.selectedIndex].text.trim();


            const newItem = { 
                id: crypto.randomUUID(), 
                input: rawInput, 
                result: result, 
                numericResult: numericResult,
                fromCurrency: fromCurrencyName, 
                toCurrency: toCurrencyName, 
                timestamp: timestamp, 
                fromSymbol: fromSymbol, 
                toSymbol: toSymbol,
                rateUsed: rateUsed, // Tasa usada en la conversi√≥n
                rateCurrencySymbol: rateCurrencySymbol, // S√≠mbolo de la divisa de la tasa
                tag: "",
                paymentMethod: "" // NUEVO: Inicializar el m√©todo de pago
            };
            history.unshift(newItem);
            if (history.length > 25) { 
                history.pop();
            }
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';

            if (history.length === 0) {
                historyList.innerHTML = '<p class="text-center text-gray-500">A√∫n no hay conversiones en tu historial.</p>';
                return;
            } 
            
            history.forEach((item) => {
                const listItem = document.createElement('li');
                listItem.classList.add('card', 'p-3', 'rounded-lg', 'history-item', 'border', 'border-gray-700', 'flex', 'flex-col', 'sm:flex-row', 'items-start', 'sm:items-center', 'space-y-2', 'sm:space-y-0');
                
                const tagDisplay = item.tag 
                    ? `<span class="bg-blue-800 text-blue-100 text-xs font-semibold px-2 py-0.5 rounded-full truncate max-w-xs">${item.tag.split('\n')[0].substring(0, 40)}...</span>` 
                    : '';
                
                // Muestra el m√©todo de pago si existe
                const paymentDisplay = item.paymentMethod 
                    ? `<span class="bg-purple-800 text-purple-100 text-xs font-semibold px-2 py-0.5 rounded-full truncate max-w-xs">${item.paymentMethod}</span>`
                    : '';

                listItem.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-1">
                            ${tagDisplay}
                            ${paymentDisplay}
                            <p class="text-xs text-gray-500">${item.timestamp}</p>
                        </div>
                        <p class="text-sm">
                            <span class="font-bold">${item.input} ${item.fromSymbol}</span> a 
                            <span class="text-green-400 font-bold">${item.result} ${item.toSymbol}</span>
                        </p>
                    </div>

                    <div class="flex space-x-2 flex-shrink-0 mt-2 sm:mt-0">
                        ${item.tag || item.paymentMethod ? `
                            <button onclick="openViewModal('${item.id}')" title="Ver detalle de etiqueta y tasas" class="view-details-btn hover:text-green-400">
                                <!-- Icono de Ojo (Eye) -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0m-0 -4v4"></path><path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0"></path><path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6"></path></svg>
                            </button>
                        ` : ''}
                        
                        <button onclick="openEditModal('${item.id}')" title="Etiquetar" class="edit-tag-btn hover:text-blue-400">
                            <!-- Icono de L√°piz (Pencil) -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4"></path><path d="M13.5 6.5l4 4"></path></svg>
                        </button>

                        <button onclick="deleteHistoryItem('${item.id}')" title="Eliminar" class="delete-history-item hover:text-red-500">
                            <!-- Icono de Papelera (Trash) -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0m-0 -4v4"></path><path d="M4 7l16 0"></path><path d="M10 11l0 6"></path><path d="M14 11l0 6"></path><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"></path><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"></path></svg>
                        </button>
                    </div>
                `;
                historyList.appendChild(listItem);
            });
        }
        
        // --- L√≥gica de Tasas ---

        function updateUIWithRates(data, isUpdate) {
            rates = data.rates;
            
            const formattedDate = new Intl.DateTimeFormat('es-VE', {
                day: 'numeric', month: 'long', year: 'numeric'
            }).format(new Date(data.timestamp));

            document.getElementById('last-updated').textContent = formattedDate;
            document.getElementById('last-updated-label').textContent = 'Fecha Actual:';
            
            updateDisplay(currentCurrency, isUpdate); 
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('rate-display').classList.remove('hidden');
            updateConversionInputPlaceholder();
        }
        
        function updateDisplay(currency, isUpdate = false) {
            const rateInfo = rates[currency];
            const usdtNotice = document.getElementById('usdt-notice');
            const sourceTextElement = document.getElementById('source-text');
            
            currentCurrency = currency;

            if (currency === 'USDT') {
                sourceTextElement.textContent = 'Fuente: Promedio P2P de Cripto-Exchanges';
                usdtNotice.classList.remove('hidden');
            } else {
                sourceTextElement.textContent = 'Fuente: Banco Central de Venezuela (BCV)';
                usdtNotice.classList.add('hidden');
            }

            if (rateInfo) {
                // *** CAMBIO CRUCIAL: Usamos 'en-US' para que el decimal sea el PUNTO (ej: 231.04) ***
                const formattedRate = rateInfo.value.toLocaleString('en-US', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });

                currencyRateElement.textContent = `${rateInfo.symbol} ${formattedRate}`;
                
                if (isUpdate) {
                    applyFlashEffect();
                }
                
                document.getElementById('currency-select').value = currency;
            }
        }

        function updateConversionInputPlaceholder() {
            const amountInput = document.getElementById('amount-input');
            const currencySelect = document.getElementById('currency-select');
            const rateInfo = rates[currencySelect.value];
            
            const currencyLabel = currencySelect.options[currencySelect.selectedIndex].text.split(' ')[0]; 

            if (conversionDirection === 'bs-to-currency') {
                amountInput.placeholder = 'Cantidad en Bol√≠vares (Bs) (ej: 1000+50-10)';
            } else {
                amountInput.placeholder = `Cantidad en ${currencyLabel} (${rateInfo.displaySymbol}) (ej: 10+5-2.5)`;
            }
        }
        
        // Funci√≥n para inicializar las tasas (con los nuevos valores)
        function initRates(isManualUpdate = false) {
             const data = {
                 rates: {
                     // Las tasas son datos de ejemplo
                     'USD': { value: 231.04, symbol: 'Bs', conversion: 231.04, displaySymbol: '$' }, 
                     'EUR': { value: 267.63, symbol: 'Bs', conversion: 267.63, displaySymbol: '‚Ç¨' },
                     'USDT': { value: 394.59, symbol: 'Bs', conversion: 394.59, displaySymbol: '‚ÇÆ' },
                 },
                 timestamp: Date.now() 
             };
             updateUIWithRates(data, isManualUpdate);
        }
        
        // --- Event Listeners ---
        
        document.getElementById('convert-btn').addEventListener('click', convertCurrency);
        document.getElementById('copy-btn').addEventListener('click', copyToClipboard);
        document.getElementById('clear-history-btn').addEventListener('click', clearHistory); 
        document.getElementById('show-time-btn').addEventListener('click', () => {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-VE', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
            showMessage(`Hora actual: ${timeString}`, 5000);
        });
        document.getElementById('refresh-page-btn').addEventListener('click', () => { window.location.reload(); });
        document.getElementById('refresh-btn').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('rate-display').classList.add('hidden');
            setTimeout(() => {
                initRates(true);
                showMessage("Tasa actualizada.", 3000);
            }, 500);
        });

        document.getElementById('conversion-toggle-btn').addEventListener('click', () => {
            const toggleIcon = document.getElementById('toggle-icon');
            if (conversionDirection === 'currency-to-bs') {
                document.getElementById('toggle-text').textContent = 'Bol√≠vares a Divisa';
                toggleIcon.style.transform = 'rotate(180deg)';
                conversionDirection = 'bs-to-currency';
            } else {
                document.getElementById('toggle-text').textContent = 'Divisa a Bol√≠vares';
                toggleIcon.style.transform = 'rotate(0deg)';
                conversionDirection = 'currency-to-bs';
            }
            updateConversionInputPlaceholder();
        });

        document.getElementById('currency-display-select').addEventListener('change', (event) => {
            updateDisplay(event.target.value, true); 
        });
        document.getElementById('currency-select').addEventListener('change', updateConversionInputPlaceholder);
        
        // Event listeners para Modales
        settingsBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            const isMenuOpen = settingsMenu.style.display === 'block';
            settingsMenu.style.display = isMenuOpen ? 'none' : 'block';
            gearIcon.classList.toggle('active', !isMenuOpen);
        });

        document.getElementById('save-tag-btn').addEventListener('click', saveTag);
        document.getElementById('confirm-delete-btn').addEventListener('click', confirmDelete); // Bot√≥n de confirmaci√≥n

        tagInput.addEventListener('input', () => {
            tagCharCount.textContent = tagInput.value.length;
        });

        window.onload = () => {
            initRates(false); 
            loadHistory();
            updateConversionInputPlaceholder();
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasa VE - Conversor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        .theme-dark {
            --bg-color: #0d1117;
            --text-color: #c9d1d9;
            --card-bg: #161b22;
            --border-color: #30363d;
            --accent-color: #10B981;
            --secondary-text: #8b949e;
            --gradient-start: #10B981;
            --gradient-end: #059669;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            padding: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        .card { background-color: var(--card-bg); }
        .border-gray-700 { border-color: var(--border-color); }
        .text-green-400 { color: var(--accent-color); }
        .text-gray-400 { color: var(--secondary-text); }
        
        .gradient-button {
            background-image: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);
            transition: all 0.3s ease;
        }

        .gradient-button:hover {
            background-image: linear-gradient(to right, var(--gradient-end), var(--gradient-start));
            box-shadow: 0 6px 12px rgba(16, 185, 129, 0.4);
            transform: translateY(-2px);
        }

        .converter-input, .modal-textarea, .custom-select-trigger {
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease-in-out;
            width: 100%;
            outline: none;
        }
        
        .custom-select-trigger {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .converter-input:hover, .custom-select-trigger:hover { border-color: var(--accent-color); }
        .converter-input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
        
        .spinner {
            border: 4px solid var(--border-color);
            border-radius: 50%;
            border-top: 4px solid var(--accent-color);
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes flash-rate {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            50% { box-shadow: 0 0 10px 5px rgba(16, 185, 129, 0.4); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .rate-flash {
            animation: flash-rate 0.8s ease-out;
        }

        .delete-history-item, .edit-tag-btn, .view-details-btn {
            color: var(--secondary-text);
            transition: transform 0.2s ease;
            padding: 0.3rem;
            border-radius: 50%;
        }

        .delete-history-item { color: #EF4444; background-color: transparent; }
        .edit-tag-btn:hover { color: #3B82F6; } 
        .view-details-btn:hover { color: #10B981; } 
        .delete-history-item:hover { color: #DC2626; transform: scale(1.1); }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #settings-menu {
            position: absolute;
            top: 65px;
            right: 1.5rem;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 50;
            min-width: 250px;
            padding: 1rem;
            display: none;
        }

        .config-button {
            background-color: var(--border-color);
            color: var(--text-color);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
            width: 100%;
            text-align: left;
        }
        
        .config-button:hover { background-color: #3B4452; }
        
        .custom-rate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #1f2937;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-color);
        }

        #message-box {
            position: fixed;
            top: 2rem; 
            left: 50%;
            transform: translateX(-50%); 
            padding: 1rem 2rem;
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            text-align: center;
            max-width: 80%;
            white-space: normal;
        }
        
        .gear-icon { transition: transform 0.3s ease-in-out; }
        .gear-icon:hover, .gear-icon.active { transform: rotate(45deg); }
        .fixed-gear { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 100; }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--card-bg);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            padding: 1.5rem;
            position: relative;
        }

        .device-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
            color: var(--secondary-text);
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .emoji-option {
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            text-align: center;
            font-size: 1.5rem;
            border: 2px solid transparent;
            background-color: #1f2937;
            transition: all 0.2s;
        }
        .emoji-option:hover { background-color: #374151; }
        .emoji-option.selected {
            border-color: var(--accent-color);
            background-color: rgba(16, 185, 129, 0.1);
        }
        
        .disabled-btn {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .swap-container {
            position: relative;
            height: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        .swap-btn {
            background-color: var(--card-bg);
            border: 2px solid var(--border-color);
            color: var(--accent-color);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.5s ease, border-color 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-weight: bold;
            font-size: 0.8rem;
            line-height: 1;
        }
        .swap-btn:hover {
            border-color: var(--accent-color);
            transform: scale(1.1);
        }
        
        .swap-btn.rotated {
            transform: rotate(180deg) scale(1.1);
        }
        
        .swap-btn > span { transition: transform 0.5s ease; }
        .swap-btn.rotated > span { transform: rotate(-180deg); }

        .swap-btn .icon-top { margin-bottom: 2px; }
        .swap-btn .icon-bottom { margin-top: 2px; }

        .currency-option-card {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background-color: #1f2937;
            border: 1px solid transparent;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .currency-option-card:hover {
            border-color: var(--accent-color);
            background-color: #374151;
        }
        .currency-option-card.active {
            border-color: var(--accent-color);
            background-color: rgba(16, 185, 129, 0.1);
        }
        .currency-icon { font-size: 1.5rem; margin-right: 1rem; }

        .input-wrapper { position: relative; width: 100%; }
        .help-icon-btn {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-text);
            cursor: pointer;
            padding: 0.25rem;
            transition: color 0.2s;
        }
        .help-icon-btn:hover { color: var(--accent-color); }
    </style>
</head>
<body class="theme-dark">

    <div class="fixed-gear">
        <button id="settings-btn" class="text-gray-400 hover:text-green-400 focus:outline-none transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 gear-icon" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0m-0 -4v4"></path>
                <path d="M10.325 4.317c.426 -1.756 2.924 -1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543 -.94 3.31 .826 2.37 2.37a1.724 1.724 0 0 0 1.065 2.572c1.756 .426 1.756 2.924 0 3.35a1.724 1.724 0 0 0 -1.066 2.573c.94 1.543 -.826 3.31 -2.37 2.37a1.724 1.724 0 0 0 -2.572 1.065c-.426 1.756 -2.924 1.756 -3.35 0a1.724 1.724 0 0 0 -2.573 -1.066c-1.543 .94 -3.31 -.826 -2.37 -2.37a1.724 1.724 0 0 0 -1.065 -2.572c-1.756 -.426 -1.756 -2.924 0 -3.35a1.724 1.724 0 0 0 1.066 -2.573c-.94 -1.543 .826 -3.31 2.37 -2.37c.996 .608 2.296 .32 2.572 -1.065z"></path>
                <path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0"></path>
            </svg>
        </button>
        <div id="settings-menu" class="card rounded-xl p-4 flex flex-col space-y-4">
            
            <div id="custom-rates-list-container" class="hidden">
                <p class="text-xs text-gray-500 uppercase font-semibold mb-2">Tus Tasas:</p>
                <div id="custom-rates-list"></div>
            </div>

            <!-- ORDEN REAJUSTADO -->
            <!-- 1. A√±adir Tasa -->
            <button id="add-custom-rate-btn" class="config-button text-green-400 font-semibold border border-gray-700 hover:border-green-400">
                A√±adir Tasa Personalizada
            </button>
            <p id="max-rates-msg" class="text-xs text-red-400 text-center hidden">M√°ximo 2 tasas alcanzado</p>

            <!-- 2. Refrescar -->
            <button id="refresh-page-btn" class="config-button">
                Refrescar
            </button>

            <!-- 3. Ver Hora -->
            <button id="show-time-btn" class="config-button">
                Ver Hora
            </button>

            <!-- 4. Limpiar Historial -->
            <button id="clear-history-btn" class="config-button text-red-400">
                Limpiar Historial
            </button>
            
            <!-- 5. Informaci√≥n -->
            <button id="app-info-btn" class="config-button text-blue-400 border border-gray-700 hover:border-blue-400">
                Informaci√≥n
            </button>
            <div class="text-center text-sm text-gray-500 pt-2">
                Versi√≥n: <span id="app-version">1.0.0</span>
            </div>
        </div>
    </div>

    <main id="main-container" class="w-full h-full min-h-screen p-6 md:p-8 text-center flex flex-col justify-center animate-fade-in-section max-w-lg md:max-w-xl lg:max-w-2xl mx-auto">
        <div class="flex items-center justify-center space-x-2 w-full mb-4">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-green-400">
                <path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2ZM12 18.5C12 18.2239 11.7761 18 11.5 18H10.5C10.2239 18 10 17.7761 10 17.5V14.5C10 14.2239 10.2239 14 10.5 14H13.5C13.7761 14 14 13.7761 14 13.5V10.5C14 10.2239 13.7761 10 13.5 10H10.5C10.2239 10 10 9.77614 10 9.5V6.5C10 6.22386 10.2239 6 10.5 6H11.5C11.7761 6 12 5.77614 12 5.5V5.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 5.5V18.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h1 class="text-3xl font-bold text-green-400">Tasa VE</h1>
            
            <div id="device-icon" class="device-indicator hidden" title="Dispositivo Detectado"></div>
        </div>
        
        <p class="text-gray-400 mb-6">Tasas Actualizadas del Banco Central de Venezuela</p>
        
        <div class="animated-bar w-full h-1 rounded-full mb-6"></div>

        <!-- Selector de Visualizaci√≥n -->
        <div class="flex justify-center mb-6 relative">
            <div id="display-select-trigger" class="custom-select-trigger" onclick="openCurrencySelector('display')">
                <span id="display-select-text">Seleccionar Moneda...</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </div>
        </div>

        <div id="loading" class="flex items-center justify-center space-x-2 text-gray-500 text-lg mb-4">
            <div class="spinner"></div>
            <span>Buscando tasa...</span>
        </div>
        
        <div id="rate-display" class="hidden">
            <div class="card p-4 rounded-lg mb-4 w-full">
                <p class="text-xl text-gray-400">Valor actual:</p>
                <div class="flex items-center justify-center space-x-2">
                    <p class="text-4xl sm:text-5xl font-bold text-green-400 mt-1 mr-2" id="currency-rate">Cargando...</p>
                    <button id="copy-btn" class="text-gray-400 hover:text-green-400 focus:outline-none transition-colors" title="Copiar Tasa">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-2M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2A2 2 0 0114 5m-5 8h4m-4 4h4" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div id="source-label" class="text-sm text-gray-500 mt-2 mb-4">
                <p id="source-text" class="font-semibold"></p>
            </div>
            
            <div id="usdt-notice" class="card p-3 rounded-xl text-sm text-red-400 border border-red-500 hidden">
                <p>‚ö†Ô∏è **ATENCI√ìN:** Tasa USDT basada en promedio P2P. Valor altamente referencial, no oficial. ¬°Opera con cautela!</p>
            </div>

            <div id="custom-notice" class="card p-3 rounded-xl text-sm text-blue-400 border border-blue-500 hidden">
                <p>üîß Tasa Personalizada por el usuario.</p>
            </div>

            <div class="text-sm text-gray-500 mt-4 flex flex-col items-center">
                <p><span id="last-updated-label">Fecha Actual:</span> <span id="last-updated" class="font-bold">Cargando...</span></p>
            </div>
        </div>
        <div id="error-message" class="hidden text-red-400 text-sm mt-2"></div>

        <button id="refresh-btn" class="w-full mt-4 text-white font-semibold py-3 px-4 rounded-xl gradient-button pulse-animation">
            Actualizar Tasa
        </button>

        <div class="mt-8 pt-6 border-t border-gray-700 text-left">
            <h2 class="text-2xl font-bold text-green-400 mb-4">Conversor de Divisas</h2>
            
            <div class="flex flex-col space-y-2 mb-4 items-center justify-center relative">
                <div class="input-wrapper">
                    <input 
                        type="text" 
                        id="amount-input" 
                        class="converter-input" 
                        placeholder="Cantidad (ej: 100+50-10)" 
                    >
                    <button class="help-icon-btn" onclick="openHelpModal()" title="Ayuda del conversor">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                </div>
                
                <div class="swap-container w-full">
                    <button id="swap-conversion-btn" class="swap-btn" title="Invertir Conversi√≥n">
                        <span class="icon-top text-lg text-green-400">$</span>
                        <span class="icon-bottom text-base text-green-400">Bs</span>
                    </button>
                </div>

                <div id="converter-select-trigger" class="custom-select-trigger w-full p-3" onclick="openCurrencySelector('converter')">
                    <span id="converter-select-text">Seleccionar Moneda...</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>
            
            <button id="convert-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors">
                Convertir
            </button>
            
            <div id="conversion-result" class="mt-4 p-4 card rounded-lg hidden">
                <div id="converted-value" class="text-3xl font-bold text-green-400 mb-2"></div>
                <p id="conversion-direction-text" class="text-sm text-gray-400 text-center"></p>
            </div>
        </div>

        <div class="mt-8 pt-6 border-t border-gray-700 text-left">
            <h2 class="text-2xl font-bold text-green-400 mb-4">Historial de Conversiones</h2>
            <ul id="history-list" class="space-y-2 text-gray-400"></ul>
        </div>
    </main>

    <div id="message-box" class="hidden">
        <p id="msg-text">¬°Tasa copiada al portapapeles!</p>
    </div>

    <!-- Modal: Selecci√≥n de Moneda -->
    <div id="currency-selector-modal" class="modal">
        <div class="modal-content w-full max-w-sm">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-green-400">Seleccionar Tasa</h3>
                <button onclick="closeModal('currency-selector-modal')" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="currency-options-list" class="max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Modal: Tasa Personalizada -->
    <div id="custom-rate-modal" class="modal">
        <div class="modal-content w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-green-400">A√±adir Tasa Personalizada</h3>
            <p class="text-sm text-gray-300 mb-2">Selecciona un Icono:</p>
            <div class="emoji-grid" id="emoji-selector">
                <div class="emoji-option selected" data-emoji="üîß">üîß</div>
                <div class="emoji-option" data-emoji="üè¶">üè¶</div>
                <div class="emoji-option" data-emoji="üí≥">üí≥</div>
                <div class="emoji-option" data-emoji="üì¶">üì¶</div>
                <div class="emoji-option" data-emoji="ü§ù">ü§ù</div>
                <div class="emoji-option" data-emoji="ü™ô">ü™ô</div>
                <div class="emoji-option" data-emoji="ü¶Ñ">ü¶Ñ</div>
                <div class="emoji-option" data-emoji="üöÄ">üöÄ</div>
                <div class="emoji-option" data-emoji="üíº">üíº</div>
                <div class="emoji-option" data-emoji="üè†">üè†</div>
            </div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Nombre (Ej: Zelle, PayPal)</label>
            <input type="text" id="custom-rate-name" class="converter-input w-full mb-3" placeholder="Nombre (Max 20 caracteres)" maxlength="20">
            <label class="block text-sm font-medium text-gray-300 mb-1">Valor en Bol√≠vares (Max 4 d√≠gitos)</label>
            <input type="number" id="custom-rate-value" class="converter-input w-full mb-6" placeholder="0.00" step="any" max="9999">
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal('custom-rate-modal')" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Cancelar</button>
                <button id="save-custom-rate-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Guardar Tasa</button>
            </div>
        </div>
    </div>

    <!-- Modal: Editar Etiqueta -->
    <div id="edit-tag-modal" class="modal">
        <div class="modal-content w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">A√±adir/Editar Etiqueta</h3>
            <p class="text-sm text-gray-400 mb-3">Est√°s etiquetando: <span id="edit-modal-input-summary" class="font-semibold text-green-400"></span></p>
            <textarea id="tag-input" class="modal-textarea w-full p-3 mb-2" placeholder="Etiqueta o Nota (m√°x. 200 caracteres)" maxlength="200" rows="4"></textarea>
            <p class="text-xs text-right text-gray-500 mb-4"><span id="tag-char-count">0</span> / 200</p>
            <div class="mb-6 pt-4 border-t border-gray-700">
                <label for="payment-select" class="block text-sm font-medium text-gray-400 mb-2">Si has comprado y deseas poner la opci√≥n de pago que utilizaste puedes seleccionar (opcional)</label>
                <select id="payment-select" class="modal-textarea w-full p-2 text-sm">
                    <option value="">-- No especificado --</option>
                    <option value="PagoMovil">PagoMovil</option>
                    <option value="Transferencia">Transferencia</option>
                    <option value="Efectivo">Efectivo</option>
                </select>
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal('edit-tag-modal')" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Cancelar</button>
                <button id="save-tag-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Ver Detalles -->
    <div id="view-details-modal" class="modal">
        <div class="modal-content w-full max-w-xl">
            <h3 class="text-2xl font-bold mb-4 text-green-400">Detalle de Conversi√≥n</h3>
            <button onclick="closeModal('view-details-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0m-0 -4v4"></path><path d="M18 6l-12 12"></path><path d="M6 6l12 12"></path></svg>
            </button>
            <div class="mb-4 p-5 bg-gray-800 rounded-lg border-l-4 border-blue-500 text-center">
                <p class="text-sm font-semibold uppercase text-blue-300">Etiqueta de Conversi√≥n:</p>
                <p id="view-modal-tag" class="text-xl font-semibold text-white break-words whitespace-pre-wrap mt-1"></p>
            </div>
            <label class="block text-sm font-medium text-gray-400 mb-1">Detalle de la Transacci√≥n:</label>
            <textarea readOnly id="view-modal-details" rows="7" class="modal-textarea w-full p-4 text-sm"></textarea>
            <div id="view-modal-timestamp" class="text-right text-xs text-gray-500 mt-2"></div>
        </div>
    </div>
    
    <!-- Modal: Confirmar Borrado Historial Individual -->
    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content w-full max-w-xs">
            <h3 class="text-xl font-bold mb-4 text-red-500">Confirmaci√≥n Necesaria</h3>
            <p class="text-gray-200 mb-6">¬øEst√°s seguro de eliminar esta conversi√≥n del historial? Esta acci√≥n no se puede deshacer.</p>
            <div class="flex justify-between space-x-3">
                <button onclick="closeModal('delete-confirm-modal')" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">No, Cancelar</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">S√≠, Eliminar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Confirmar Limpiar Historial Completo -->
    <div id="clear-history-confirm-modal" class="modal">
        <div class="modal-content w-full max-w-sm text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 class="text-xl font-bold mb-2 text-white">¬°Cuidado!</h3>
            <p class="text-gray-300 mb-6">¬øEst√°s seguro de realizar esta acci√≥n? El historial se borrar√° permanentemente y <strong>no se puede deshacer</strong>.</p>
            <div class="flex justify-center space-x-3">
                <button onclick="closeModal('clear-history-confirm-modal')" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Cancelar</button>
                <button id="confirm-clear-history-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg disabled-btn transition-colors" disabled>
                    S√≠, borrar (<span id="clear-countdown">5</span>)
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Confirmar Borrado Tasa -->
    <div id="delete-rate-confirm-modal" class="modal">
        <div class="modal-content w-full max-w-xs">
            <h3 class="text-xl font-bold mb-4 text-red-500">Borrar Tasa</h3>
            <p class="text-gray-200 mb-6">¬øEst√°s seguro de borrar la tasa personalizada <span id="delete-rate-name-span" class="font-bold text-white"></span>?</p>
            <div class="flex justify-between space-x-3">
                <button onclick="closeModal('delete-rate-confirm-modal')" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Cancelar</button>
                <button id="confirm-delete-rate-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">S√≠, Borrar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Ayuda del Conversor (NUEVO) -->
    <div id="help-modal" class="modal">
        <div class="modal-content w-full max-w-md">
            <h3 class="text-xl font-bold mb-4 text-green-400">Gu√≠a del Conversor</h3>
            <ul class="list-disc list-inside text-gray-300 space-y-3 text-sm text-left">
                <li><strong>Monto Simple:</strong> Escribe el n√∫mero que deseas convertir (ej: <code>500</code>).</li>
                <li><strong>Formatos Inteligentes:</strong> Soporta puntos y comas. Ej: <code>10.324,45</code> o <code>10.324.45</code> se leen correctamente como diez mil.</li>
                <li><strong>C√°lculos R√°pidos:</strong> Puedes usar sumas y restas directamente (ej: <code>100+50-20</code>) y el sistema calcular√° el total.</li>
                <li><strong>Historial y Etiquetas:</strong> Cada conversi√≥n se guarda en el historial de abajo. Usa el icono de etiqueta (üè∑Ô∏è) para a√±adir notas o indicar si pagaste con PagoMovil, Efectivo, etc.</li>
            </ul>
            <button onclick="closeModal('help-modal')" class="mt-6 w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Entendido</button>
        </div>
    </div>

    <!-- Modal: Informaci√≥n App (NUEVO) -->
    <div id="app-info-modal" class="modal">
        <div class="modal-content w-full max-w-xs text-center">
            <h3 class="text-2xl font-bold mb-2 text-green-400">Tasa VE</h3>
            <p class="text-gray-400 mb-6 text-sm">Tu conversor de confianza.</p>
            
            <div class="bg-gray-800 p-4 rounded-lg mb-6 border border-gray-700">
                <p class="text-gray-300 mb-1 font-semibold">Desarrollado por:</p>
                <p class="text-green-400 font-bold text-lg mb-3">TasaVE.Devs</p>
                <div class="border-t border-gray-700 my-2"></div>
                <p class="text-gray-400 text-sm italic">Mi firma: OAMH</p>
            </div>
            
            <p class="text-xs text-gray-500 mb-4">Versi√≥n: 1.0.0</p>
            
            <button onclick="closeModal('app-info-modal')" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Cerrar</button>
        </div>
    </div>
    
    <script>
        const baseDefaultRates = {
            'USD': { value: 251.88, symbol: 'Bs', conversion: 251.88, displaySymbol: '$' },
            'EUR': { value: 293.88, symbol: 'Bs', conversion: 293.88, displaySymbol: '‚Ç¨' },
            'USDT': { value: 377.65, symbol: 'Bs', conversion: 377.65, displaySymbol: '‚ÇÆ' }
        };

        let rates = {}; 
        const DEFAULT_CURRENCIES = ['USD', 'EUR', 'USDT'];
        let customRates = {}; 
        const MAX_CUSTOM_RATES = 2;
        let currentCurrency = 'USD';
        
        let displayCurrency = 'USD';
        let converterCurrency = 'USD';
        
        let conversionDirection = 'currency-to-bs';
        
        const HISTORY_KEY = 'conversionHistory';
        const CUSTOM_RATES_KEY = 'customRates'; 
        let msgTimeout;
        let clearHistoryInterval; 
        let editingHistoryId = null; 
        let pendingDeleteId = null; 
        let pendingDeleteRateName = null; 
        let selectedEmoji = 'üîß'; 
        let activeSelectorContext = null; 

        const settingsBtn = document.getElementById('settings-btn');
        const settingsMenu = document.getElementById('settings-menu');
        const gearIcon = document.querySelector('.gear-icon');
        const currencyRateElement = document.getElementById('currency-rate');
        const tagInput = document.getElementById('tag-input');
        const tagCharCount = document.getElementById('tag-char-count');
        const emojiOptions = document.querySelectorAll('.emoji-option');
        
        // --- Helpers UI ---
        
        function showMessage(message, duration = 3000) {
            const msgBox = document.getElementById('message-box');
            const msgText = document.getElementById('msg-text');
            msgText.textContent = message;
            clearTimeout(msgTimeout);
            msgBox.style.display = 'block';
            setTimeout(() => { msgBox.style.opacity = 1; }, 10);
            msgTimeout = setTimeout(() => {
                const msgBox = document.getElementById('message-box');
                msgBox.style.opacity = 0;
                setTimeout(() => { msgBox.style.display = 'none'; }, 300);
            }, duration);
        }

        function copyToClipboard() {
            const rateInfo = rates[displayCurrency];
            const rawRateText = currencyRateElement.textContent.trim().split(' ')[1]; 
            const valueToCopy = rawRateText.replace(/,/g, ''); 
            
            let clipboardText = "";

            if (rateInfo && rateInfo.isCustom) {
                clipboardText = `Tasa VE Mi Tasa Personalizada de Usuario es ${displayCurrency} es de ${rawRateText}`;
            } else {
                clipboardText = `Tasa VE: El valor Actual ${displayCurrency} es ${rawRateText}`;
            }

            const tempInput = document.createElement('textarea');
            tempInput.value = clipboardText; 
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            
            showMessage("¬°Informaci√≥n de tasa copiada!", 3000);
        }

        function applyFlashEffect() {
            currencyRateElement.classList.remove('rate-flash');
            void currencyRateElement.offsetWidth; 
            currencyRateElement.classList.add('rate-flash');
            setTimeout(() => { currencyRateElement.classList.remove('rate-flash'); }, 800);
        }

        document.addEventListener('click', (e) => {
            const target = e.target;
            const isInput = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.tagName === 'SELECT';
            const isButton = target.tagName === 'BUTTON' || target.closest('button');
            const isSettings = target.closest('#settings-menu') || target.closest('#settings-btn');
            
            if (!isInput && !isButton && !isSettings) {
                if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) {
                    document.activeElement.blur();
                }
            }
        });

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
                if (event.target.id === 'clear-history-confirm-modal') {
                    clearInterval(clearHistoryInterval);
                }
            }
            if (!event.target.closest('#settings-menu') && !event.target.closest('#settings-btn')) {
                if (settingsMenu.style.display === 'block') {
                    settingsMenu.style.display = 'none';
                    gearIcon.classList.remove('active');
                }
            }
        }

        function closeAllMenus() {
            settingsMenu.style.display = 'none';
            gearIcon.classList.remove('active');
        }

        emojiOptions.forEach(option => {
            option.addEventListener('click', () => {
                emojiOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                selectedEmoji = option.getAttribute('data-emoji');
            });
        });

        window.closeModal = function(id) {
            document.getElementById(id).style.display = 'none';
            if (id === 'clear-history-confirm-modal') {
                clearInterval(clearHistoryInterval);
            }
        }

        window.openHelpModal = function() {
            closeAllMenus();
            document.getElementById('help-modal').style.display = 'flex';
        }

        document.getElementById('app-info-btn').addEventListener('click', () => {
            closeAllMenus();
            document.getElementById('app-info-modal').style.display = 'flex';
        });

        window.openCurrencySelector = function(context) {
            closeAllMenus(); 
            activeSelectorContext = context; 
            const listContainer = document.getElementById('currency-options-list');
            listContainer.innerHTML = ''; 
            
            const allRatesKeys = Object.keys(rates);
            const orderedKeys = [...DEFAULT_CURRENCIES.filter(k => allRatesKeys.includes(k)), ...allRatesKeys.filter(k => !DEFAULT_CURRENCIES.includes(k))];
            
            const currentSelected = context === 'display' ? displayCurrency : converterCurrency;

            orderedKeys.forEach(key => {
                const rate = rates[key];
                let labelName = '';
                let labelEmoji = '';
                
                if (key === 'USD') { labelName = 'D√≥lar (USD)'; labelEmoji = 'üá∫üá∏'; }
                else if (key === 'EUR') { labelName = 'Euro (EUR)'; labelEmoji = 'üá™üá∫'; }
                else if (key === 'USDT') { labelName = 'USDT (Tether)'; labelEmoji = '‚ÇÆ'; }
                else { labelName = key; labelEmoji = rate.displaySymbol; }

                const item = document.createElement('div');
                item.className = `currency-option-card ${currentSelected === key ? 'active' : ''}`;
                item.innerHTML = `
                    <span class="currency-icon">${labelEmoji}</span>
                    <span class="font-bold text-gray-200 text-lg">${labelName}</span>
                `;
                
                item.onclick = () => selectCurrencyFromModal(key);
                listContainer.appendChild(item);
            });

            document.getElementById('currency-selector-modal').style.display = 'flex';
        }

        function selectCurrencyFromModal(key) {
            if (activeSelectorContext === 'display') {
                displayCurrency = key;
                updateDisplay(key, true);
            } else if (activeSelectorContext === 'converter') {
                converterCurrency = key;
                updateConverterUI();
            }
            closeModal('currency-selector-modal');
        }

        function updateSelectTriggers() {
            const displayRate = rates[displayCurrency];
            if (displayRate) {
                let label = displayCurrency;
                let emoji = displayRate.displaySymbol;
                if (displayCurrency === 'USD') emoji = 'üá∫üá∏'; 
                if (displayCurrency === 'EUR') emoji = 'üá™üá∫';
                if (displayCurrency === 'USDT') emoji = '‚ÇÆ';
                
                document.getElementById('display-select-text').innerHTML = `<span class="mr-2">${emoji}</span> ${label}`;
            }

            const converterRate = rates[converterCurrency];
            if (converterRate) {
                let label = converterCurrency;
                let emoji = converterRate.displaySymbol;
                if (converterCurrency === 'USD') emoji = 'üá∫üá∏'; 
                if (converterCurrency === 'EUR') emoji = 'üá™üá∫';
                if (converterCurrency === 'USDT') emoji = '‚ÇÆ';

                document.getElementById('converter-select-text').innerHTML = `<span class="mr-2">${emoji}</span> ${label}`;
            }
        }

        document.getElementById('clear-history-btn').addEventListener('click', () => {
            closeAllMenus();
            const modal = document.getElementById('clear-history-confirm-modal');
            const confirmBtn = document.getElementById('confirm-clear-history-btn');
            const countdownSpan = document.getElementById('clear-countdown');
            
            let timeLeft = 5;
            confirmBtn.disabled = true;
            confirmBtn.classList.add('disabled-btn');
            confirmBtn.classList.remove('hover:bg-red-700');
            countdownSpan.textContent = timeLeft;
            confirmBtn.innerHTML = `S√≠, borrar (${timeLeft})`;
            
            modal.style.display = 'flex';
            
            clearInterval(clearHistoryInterval);
            clearHistoryInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft > 0) {
                    countdownSpan.textContent = timeLeft;
                    confirmBtn.innerHTML = `S√≠, borrar (${timeLeft})`;
                } else {
                    clearInterval(clearHistoryInterval);
                    confirmBtn.disabled = false;
                    confirmBtn.classList.remove('disabled-btn');
                    confirmBtn.classList.add('hover:bg-red-700');
                    confirmBtn.innerHTML = `S√≠, borrar definitivamente`;
                }
            }, 1000);
        });

        document.getElementById('confirm-clear-history-btn').addEventListener('click', () => {
            localStorage.removeItem(HISTORY_KEY);
            loadHistory();
            closeModal('clear-history-confirm-modal');
            showMessage("¬°Historial borrado permanentemente!", 3000);
        });


        window.openCustomRateModal = function() {
            if (Object.keys(customRates).length >= MAX_CUSTOM_RATES) {
                showMessage("Has alcanzado el l√≠mite m√°ximo de 2 tasas personalizadas.", 3000);
                return;
            }
            closeAllMenus();
            
            document.getElementById('custom-rate-name').value = '';
            document.getElementById('custom-rate-value').value = '';
            
            emojiOptions.forEach(opt => opt.classList.remove('selected'));
            document.querySelector('.emoji-option[data-emoji="üîß"]').classList.add('selected');
            selectedEmoji = 'üîß';

            document.getElementById('custom-rate-modal').style.display = 'flex';
        }

        function updateSettingsMenu() {
            const listContainer = document.getElementById('custom-rates-list-container');
            const listDiv = document.getElementById('custom-rates-list');
            const addBtn = document.getElementById('add-custom-rate-btn');
            const maxMsg = document.getElementById('max-rates-msg');
            
            const customKeys = Object.keys(customRates);
            const count = customKeys.length;

            if (count >= MAX_CUSTOM_RATES) {
                addBtn.classList.add('hidden');
                maxMsg.classList.remove('hidden');
            } else {
                addBtn.classList.remove('hidden');
                maxMsg.classList.add('hidden');
            }

            if (count > 0) {
                listContainer.classList.remove('hidden');
                listDiv.innerHTML = '';
                
                customKeys.forEach(key => {
                    const item = document.createElement('div');
                    item.className = 'custom-rate-item';
                    const rate = customRates[key];
                    
                    item.innerHTML = `
                        <div class="flex items-center text-sm">
                            <span class="mr-2 text-xl">${rate.displaySymbol}</span>
                            <span class="font-semibold text-gray-300 truncate w-32">${key}</span>
                        </div>
                        <button onclick="confirmDeleteRate('${key}')" class="text-red-400 hover:text-red-300 p-1 hover:bg-gray-700 rounded transition-colors" title="Borrar Tasa">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    listDiv.appendChild(item);
                });
            } else {
                listContainer.classList.add('hidden');
            }
        }

        window.confirmDeleteRate = function(name) {
            closeAllMenus();
            pendingDeleteRateName = name;
            document.getElementById('delete-rate-name-span').textContent = name;
            document.getElementById('delete-rate-confirm-modal').style.display = 'flex';
        }

        window.saveCustomRate = function() {
            if (Object.keys(customRates).length >= MAX_CUSTOM_RATES) {
                showMessage("L√≠mite de tasas alcanzado.", 3000);
                return;
            }

            const nameInput = document.getElementById('custom-rate-name');
            const valueInput = document.getElementById('custom-rate-value');
            
            const name = nameInput.value.trim().toUpperCase();
            const value = parseFloat(valueInput.value);

            if (!name) { showMessage("Ingresa un nombre.", 3000); return; }
            if (customRates[name] || DEFAULT_CURRENCIES.includes(name)) { showMessage("Nombre duplicado.", 3000); return; }
            if (isNaN(value) || value <= 0) { showMessage("Valor inv√°lido.", 3000); return; }
            if (value > 9999) { showMessage("M√°x 4 d√≠gitos.", 3000); return; }

            customRates[name] = {
                value: value,
                symbol: 'Bs',
                conversion: value,
                displaySymbol: selectedEmoji, 
                isCustom: true 
            };

            localStorage.setItem(CUSTOM_RATES_KEY, JSON.stringify(customRates));
            mergeRatesAndUpdateUI();
            
            closeModal('custom-rate-modal');
            showMessage(`Tasa "${name}" agregada.`, 3000);
            
            displayCurrency = name;
            updateDisplay(name, true);
        }

        document.getElementById('confirm-delete-rate-btn').addEventListener('click', () => {
            if (pendingDeleteRateName && customRates[pendingDeleteRateName]) {
                delete customRates[pendingDeleteRateName];
                localStorage.setItem(CUSTOM_RATES_KEY, JSON.stringify(customRates));
                
                if (displayCurrency === pendingDeleteRateName) displayCurrency = 'USD';
                if (converterCurrency === pendingDeleteRateName) converterCurrency = 'USD';

                mergeRatesAndUpdateUI(); 
                showMessage(`Tasa "${pendingDeleteRateName}" eliminada.`, 3000);
            }
            pendingDeleteRateName = null;
            closeModal('delete-rate-confirm-modal');
        });

        window.openEditModal = function(id) {
            closeAllMenus();
            editingHistoryId = id;
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            const item = history.find(i => i.id === id);
            if (!item) return;
            const summary = item.input.length > 50 ? item.input.substring(0, 50) + '...' : item.input;
            document.getElementById('edit-modal-input-summary').textContent = `${summary}`;
            tagInput.value = item.tag || '';
            tagCharCount.textContent = tagInput.value.length;
            document.getElementById('payment-select').value = item.paymentMethod || ''; 
            document.getElementById('edit-tag-modal').style.display = 'flex';
        }

        window.openViewModal = function(id) {
            closeAllMenus();
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            const item = history.find(i => i.id === id);
            if (!item) return;
            
            let rateUsedText = '';
            if (item.rateUsed) {
                const storedRate = parseFloat(item.rateUsed).toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                rateUsedText = `
                    <p class="text-sm mt-3 text-gray-400">
                        <span class="font-bold text-yellow-300">Tasa USADA:</span> Bs ${storedRate}
                    </p>
                `;
            }

            const rateUsedFormatted = parseFloat(item.rateUsed).toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            let rateTypeLabel = 'Tasa de Cambio';
            
            if (item.rateCurrencySymbol === '$') rateTypeLabel = 'Tasa USD';
            else if (item.rateCurrencySymbol === '‚Ç¨') rateTypeLabel = 'Tasa EUR';
            else if (item.rateCurrencySymbol === '‚ÇÆ') rateTypeLabel = 'Tasa USDT';
            else rateTypeLabel = `Tasa ${item.fromCurrency === 'Bol√≠vares' ? item.toCurrency : item.fromCurrency}`;
            
            let detailsText = `Monto de Conversi√≥n: ${item.input} ${item.fromSymbol}\n` + 
                              `Total de Conversi√≥n: ${item.result} ${item.toSymbol}`;

            if (item.paymentMethod && item.paymentMethod !== '') {
                detailsText += `\nM√©todo de Pago: ${item.paymentMethod}`;
            }

            detailsText += `\n\nValor Actual de la Tasa: ${rateTypeLabel} = Bs ${rateUsedFormatted}`;

            document.getElementById('view-modal-tag').textContent = item.tag || 'Sin Etiqueta';
            document.getElementById('view-modal-details').value = detailsText;
            document.getElementById('view-modal-timestamp').innerHTML = `
                <p class="text-xs">ID de Transacci√≥n: ${item.id.substring(0, 8)}...</p>
                <p class="mt-1 text-xs">Fecha: ${item.timestamp}</p>
                ${rateUsedText}
            `;
            document.getElementById('view-details-modal').style.display = 'flex';
        }

        function saveTag() {
            if (!editingHistoryId) return;
            const newTag = tagInput.value.trim().substring(0, 200);
            const newPaymentMethod = document.getElementById('payment-select').value; 
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            history = history.map(item => {
                if (item.id === editingHistoryId) {
                    return { ...item, tag: newTag, paymentMethod: newPaymentMethod };
                }
                return item;
            });
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            editingHistoryId = null;
            closeModal('edit-tag-modal');
            loadHistory();
            showMessage(`Etiqueta guardada.`, 3000);
        }
        
        function deleteHistoryItem(id) {
            closeAllMenus();
            pendingDeleteId = id;
            document.getElementById('delete-confirm-modal').style.display = 'flex';
        }

        function confirmDelete() {
            if (!pendingDeleteId) return;
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            history = history.filter(item => item.id !== pendingDeleteId);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            pendingDeleteId = null;
            closeModal('delete-confirm-modal');
            loadHistory();
            showMessage("Conversi√≥n eliminada.", 3000);
        }

        function evaluateExpression(expression) {
            // Eliminar espacios
            const cleanExp = expression.replace(/\s/g, '');
            
            // Separar n√∫meros y operadores (+, -)
            const parts = cleanExp.split(/([+-])/);
            
            let total = 0;
            let currentOp = '+';
            
            for (let part of parts) {
                if (part === '+' || part === '-') {
                    currentOp = part;
                } else if (part.length > 0) {
                    let numStr = part;
                    
                    // L√≥gica inteligente de formatos num√©ricos
                    // Caso 1: Tiene coma (10.324,45) -> Es formato VE/EU
                    if (numStr.includes(',')) {
                        numStr = numStr.replace(/\./g, ''); // Quitar puntos de miles
                        numStr = numStr.replace(',', '.');  // Cambiar coma decimal a punto
                    } 
                    // Caso 2: Tiene m√∫ltiples puntos (10.324.45) -> Usuario usa punto para todo
                    // Asumimos que el √∫ltimo punto es el decimal y los anteriores son miles
                    else if ((numStr.match(/\./g) || []).length > 1) {
                        // Regex: Reemplaza puntos que est√©n seguidos por otro punto m√°s adelante
                        numStr = numStr.replace(/\.(?=.*\.)/g, '');
                    }
                    // Caso 3: Un solo punto (10.50) -> Est√°ndar JS, se deja igual
                    
                    const val = parseFloat(numStr);
                    if (!isNaN(val)) {
                        if (currentOp === '+') total += val;
                        else total -= val;
                    }
                }
            }
            return total;
        }

        function convertCurrency() {
            const amountInput = document.getElementById('amount-input');
            const conversionResultDiv = document.getElementById('conversion-result');
            const convertedValueDiv = document.getElementById('converted-value');
            
            const rawInput = amountInput.value.trim();
            const evaluatedAmount = evaluateExpression(rawInput);
            
            if (evaluatedAmount === null || evaluatedAmount < 0) { // Permitir 0, pero no negativos por l√≥gica de divisa
                showMessage("Ingrese una cantidad v√°lida.", 3000);
                conversionResultDiv.classList.add('hidden');
                return;
            }
            
            const amount = evaluatedAmount; 
            const rateInfo = rates[converterCurrency];

            if (!rateInfo) {
                showMessage("Tasa no cargada.", 3000);
                conversionResultDiv.classList.add('hidden');
                return;
            }
            
            let convertedValue;
            let fromCurrency, toCurrency, fromSymbol, toSymbol;

            if (conversionDirection === 'bs-to-currency') {
                convertedValue = (amount / rateInfo.value);
                fromCurrency = 'Bol√≠vares';
                toCurrency = converterCurrency;
                fromSymbol = 'Bs';
                toSymbol = rateInfo.displaySymbol; 
            } else {
                convertedValue = (amount * rateInfo.value);
                fromCurrency = converterCurrency;
                toCurrency = 'Bol√≠vares';
                fromSymbol = rateInfo.displaySymbol; 
                toSymbol = 'Bs';
            }
            
            const formattedConvertedValue = convertedValue.toLocaleString('es-VE', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
            
            convertedValueDiv.textContent = `${toSymbol} ${formattedConvertedValue}`;
            document.getElementById('conversion-direction-text').textContent = `${fromCurrency} ‚ûî ${toCurrency}`;

            saveConversionToHistory(rawInput, fromCurrency, toCurrency, formattedConvertedValue, fromSymbol, toSymbol, convertedValue.toFixed(2), rateInfo.value, rateInfo.displaySymbol);
            conversionResultDiv.classList.remove('hidden');
        }
        
        function saveConversionToHistory(rawInput, fromCurrency, toCurrency, result, fromSymbol, toSymbol, numericResult, rateUsed, rateCurrencySymbol) {
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            const timestamp = new Date().toLocaleString('es-VE');

            const newItem = { 
                id: crypto.randomUUID(), 
                input: rawInput, 
                result: result, 
                numericResult: numericResult,
                fromCurrency: fromCurrency, 
                toCurrency: toCurrency, 
                timestamp: timestamp, 
                fromSymbol: fromSymbol, 
                toSymbol: toSymbol,
                rateUsed: rateUsed, 
                rateCurrencySymbol: rateCurrencySymbol, 
                tag: "",
                paymentMethod: "" 
            };
            history.unshift(newItem);
            if (history.length > 25) { history.pop(); }
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';

            if (history.length === 0) {
                historyList.innerHTML = '<p class="text-center text-gray-500">A√∫n no hay conversiones en tu historial.</p>';
                return;
            } 
            
            history.forEach((item) => {
                const listItem = document.createElement('li');
                listItem.classList.add('card', 'p-3', 'rounded-lg', 'history-item', 'border', 'border-gray-700', 'flex', 'flex-col', 'sm:flex-row', 'items-start', 'sm:items-center', 'space-y-2', 'sm:space-y-0');
                
                const tagDisplay = item.tag 
                    ? `<span class="bg-blue-800 text-blue-100 text-xs font-semibold px-2 py-0.5 rounded-full truncate max-w-xs">${item.tag.split('\n')[0].substring(0, 40)}...</span>` 
                    : '';
                const paymentDisplay = item.paymentMethod 
                    ? `<span class="bg-purple-800 text-purple-100 text-xs font-semibold px-2 py-0.5 rounded-full truncate max-w-xs">${item.paymentMethod}</span>`
                    : '';

                listItem.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-1">
                            ${tagDisplay} ${paymentDisplay}
                            <p class="text-xs text-gray-500">${item.timestamp}</p>
                        </div>
                        <p class="text-sm">
                            <span class="font-bold">${item.input} ${item.fromSymbol}</span> a 
                            <span class="text-green-400 font-bold">${item.result} ${item.toSymbol}</span>
                        </p>
                    </div>
                    <div class="flex space-x-2 flex-shrink-0 mt-2 sm:mt-0">
                        ${item.tag || item.paymentMethod ? `
                            <button onclick="openViewModal('${item.id}')" title="Ver detalle" class="view-details-btn hover:text-green-400">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0m-0 -4v4"></path><path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0"></path><path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6"></path></svg>
                            </button>
                        ` : ''}
                        <button onclick="openEditModal('${item.id}')" title="Etiquetar" class="edit-tag-btn hover:text-blue-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4"></path><path d="M13.5 6.5l4 4"></path></svg>
                        </button>
                        <button onclick="deleteHistoryItem('${item.id}')" title="Eliminar" class="delete-history-item hover:text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0m-0 -4v4"></path><path d="M4 7l16 0"></path><path d="M10 11l0 6"></path><path d="M14 11l0 6"></path><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"></path><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"></path></svg>
                        </button>
                    </div>
                `;
                historyList.appendChild(listItem);
            });
        }
        
        function mergeRatesAndUpdateUI(defaultData = null) {
            let currentBaseRates = defaultData ? defaultData.rates : baseDefaultRates;
            // CRITICAL FIX: Always re-merge from base + custom to ensure deletions are reflected
            rates = { ...currentBaseRates, ...customRates };
            
            if (defaultData) {
                const formattedDate = new Intl.DateTimeFormat('es-VE', {
                    day: 'numeric', month: 'long', year: 'numeric'
                }).format(new Date(defaultData.timestamp));
                document.getElementById('last-updated').textContent = formattedDate;
            }

            updateSelectTriggers();
            updateSettingsMenu();
            updateDisplay(displayCurrency, !!defaultData);
            
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('rate-display').classList.remove('hidden');
            updateConversionInputPlaceholder();
        }

        function updateUIWithRates(data, isUpdate) {
            mergeRatesAndUpdateUI(data);
        }
        
        function updateDisplay(currency, isUpdate = false) {
            const rateInfo = rates[currency];
            const usdtNotice = document.getElementById('usdt-notice');
            const customNotice = document.getElementById('custom-notice'); 
            const sourceTextElement = document.getElementById('source-text');
            
            displayCurrency = currency;
            
            converterCurrency = currency;
            updateConverterUI();
            
            usdtNotice.classList.add('hidden');
            customNotice.classList.add('hidden');

            if (currency === 'USDT') {
                sourceTextElement.textContent = 'Fuente: Promedio P2P de Cripto-Exchanges';
                usdtNotice.classList.remove('hidden');
            } else if (rateInfo && rateInfo.isCustom) {
                sourceTextElement.textContent = 'Fuente: Usuario (Personalizado)';
                customNotice.classList.remove('hidden');
            } else {
                sourceTextElement.textContent = 'Fuente: Banco Central de Venezuela (BCV)';
            }

            if (rateInfo) {
                const formattedRate = rateInfo.value.toLocaleString('en-US', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
                currencyRateElement.textContent = `Bs ${formattedRate}`;
                if (isUpdate) applyFlashEffect();
            }
            updateSelectTriggers();
        }

        function updateConverterUI() {
            updateConversionInputPlaceholder();
            updateSelectTriggers();
        }

        function updateConversionInputPlaceholder() {
            const amountInput = document.getElementById('amount-input');
            const rateInfo = rates[converterCurrency];

            if (!rateInfo) return;

            if (conversionDirection === 'bs-to-currency') {
                amountInput.placeholder = 'Cantidad en Bol√≠vares (Bs)';
            } else {
                amountInput.placeholder = `Cantidad en ${converterCurrency} (${rateInfo.displaySymbol})`;
            }
        }

        function detectDevice() {
            const deviceIconContainer = document.getElementById('device-icon');
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
            let iconHtml = '';
            if (isMobile) {
                iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>M√≥vil`;
            } else {
                iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>PC`;
            }
            deviceIconContainer.innerHTML = iconHtml;
            deviceIconContainer.classList.remove('hidden');
        }
        
        function initRates(isManualUpdate = false) {
             const storedCustomRates = localStorage.getItem(CUSTOM_RATES_KEY);
             if (storedCustomRates) {
                 customRates = JSON.parse(storedCustomRates);
             }

             const data = {
                 rates: {
                     'USD': { value: 257.92, symbol: 'Bs', conversion: 257.92, displaySymbol: '$' }, 
                     'EUR': { value: 300.50, symbol: 'Bs', conversion: 300.50, displaySymbol: '‚Ç¨' },
                     'USDT': { value: 394.74, symbol: 'Bs', conversion: 394.74, displaySymbol: '‚ÇÆ' },
                 },
                 timestamp: Date.now() 
             };
             
             if (!isManualUpdate && DEFAULT_CURRENCIES.includes(currentCurrency)) {
                 document.getElementById('loading').classList.remove('hidden');
                 document.getElementById('rate-display').classList.add('hidden');
                 setTimeout(() => { updateUIWithRates(data, isManualUpdate); }, 800); 
             } else {
                 updateUIWithRates(data, isManualUpdate);
             }
        }
        
        document.getElementById('convert-btn').addEventListener('click', convertCurrency);
        document.getElementById('copy-btn').addEventListener('click', copyToClipboard);
        document.getElementById('show-time-btn').addEventListener('click', () => {
            closeAllMenus();
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-VE', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
            showMessage(`Hora actual: ${timeString}`, 5000);
        });
        document.getElementById('refresh-page-btn').addEventListener('click', () => { window.location.reload(); });
        document.getElementById('refresh-btn').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('refresh-btn').innerText = "Refrescando...";
            setTimeout(() => { window.location.reload(); }, 300);
        });

        document.getElementById('swap-conversion-btn').addEventListener('click', () => {
            const btn = document.getElementById('swap-conversion-btn');
            btn.classList.toggle('rotated');

            if (conversionDirection === 'currency-to-bs') {
                conversionDirection = 'bs-to-currency';
            } else {
                conversionDirection = 'currency-to-bs';
            }
            updateConversionInputPlaceholder();
            document.getElementById('conversion-result').classList.add('hidden');
        });
        
        settingsBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            const isMenuOpen = settingsMenu.style.display === 'block';
            if (isMenuOpen) {
                closeAllMenus();
            } else {
                closeAllMenus(); 
                settingsMenu.style.display = 'block';
                gearIcon.classList.add('active');
            }
        });

        document.getElementById('save-tag-btn').addEventListener('click', saveTag);
        document.getElementById('confirm-delete-btn').addEventListener('click', confirmDelete);
        document.getElementById('add-custom-rate-btn').addEventListener('click', openCustomRateModal);
        document.getElementById('save-custom-rate-btn').addEventListener('click', saveCustomRate);
        tagInput.addEventListener('input', () => { tagCharCount.textContent = tagInput.value.length; });

        window.onload = () => {
            detectDevice();
            initRates(false); 
            loadHistory();
            updateConversionInputPlaceholder();
        };
        window.onresize = detectDevice;
    </script>
</body>
</html>


